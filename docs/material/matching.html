<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="ja" xml:lang="ja"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.42">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>回帰分析とマッチング – CI4SS@Kandai</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<link href="../material/did.html" rel="next">
<link href="../material/r.html" rel="prev">
<link href="../figs/favicon.png" rel="icon" type="image/png">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting-818fc0ec18eddb34fddef0a4e6b06ca6.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap-65cf9b68e2eb4073b3e3929739b36804.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "一致なし",
    "search-matching-documents-text": "一致した文書",
    "search-copy-link-title": "検索へのリンクをコピー",
    "search-hide-matches-text": "追加の検索結果を非表示",
    "search-more-match-text": "追加の検索結果",
    "search-more-matches-text": "追加の検索結果",
    "search-clear-button-title": "消去",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "取消",
    "search-submit-button-title": "検索",
    "search-label": "サーチ"
  }
}</script>
<script async="" src="https://www.googletagmanager.com/gtag/js?id=G-9D5YDZ704S"></script>

<script type="text/javascript">

window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-9D5YDZ704S', { 'anonymize_ip': true});
</script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<link rel="stylesheet" href="../styles.css">
</head>

<body class="nav-sidebar docked nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a href="../index.html" class="navbar-brand navbar-brand-logo">
    <img src="../figs/logo.png" alt="" class="navbar-logo">
    </a>
    <a class="navbar-brand" href="../index.html">
    <span class="navbar-title">CI4SS@Kandai</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="サーチ"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="ナビゲーションを切り替える" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../syllabus.html"> 
<span class="menu-text">シラバス</span></a>
  </li>  
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-rの使い方" role="link" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">Rの使い方</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-rの使い方">    
        <li>
    <a class="dropdown-item" href="../intro/install.html">
 <span class="dropdown-text">Rの導入</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../intro/rstudio.html">
 <span class="dropdown-text">RStudioの設定</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../intro/filesystem.html">
 <span class="dropdown-text">ファイル・システム</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../intro/project.html">
 <span class="dropdown-text">プロジェクト管理</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../intro/file.html">
 <span class="dropdown-text">ファイル管理</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../intro/packages.html">
 <span class="dropdown-text">パッケージ</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-" role="link" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">講義資料</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-">    
        <li>
    <a class="dropdown-item" href="../material/intro.html">
 <span class="dropdown-text">ガイダンス</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../material/foundation.html">
 <span class="dropdown-text">因果推論の考え方</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../material/rct.html">
 <span class="dropdown-text">無作為化比較試験</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../material/r.html">
 <span class="dropdown-text">Rの復習</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../material/matching.html">
 <span class="dropdown-text">回帰分析とマッチング</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../material/did.html">
 <span class="dropdown-text">差分の差分法</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../material/rdd.html">
 <span class="dropdown-text">回帰不連続デザイン</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item">
    <a class="nav-link" href="../session.html"> 
<span class="menu-text">セッション情報</span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="サイドバーを切り替える" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../material/matching.html">回帰分析とマッチング</a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="サイドバーを切り替える" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation docked overflow-auto">
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../material/intro.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">ガイダンス</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../material/foundation.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">因果推論の考え方</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../material/rct.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">無作為化比較試験</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../material/r.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Rの復習</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../material/matching.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text">回帰分析とマッチング</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../material/did.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">差分の差分法</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../material/rdd.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">回帰不連続デザイン</span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">目次</h2>
   
  <ul>
  <li><a href="#スライド" id="toc-スライド" class="nav-link active" data-scroll-target="#スライド">スライド</a></li>
  <li><a href="#セットアップ" id="toc-セットアップ" class="nav-link" data-scroll-target="#セットアップ">セットアップ</a></li>
  <li><a href="#回帰分析" id="toc-回帰分析" class="nav-link" data-scroll-target="#回帰分析">回帰分析</a>
  <ul class="collapse">
  <li><a href="#dim推定量" id="toc-dim推定量" class="nav-link" data-scroll-target="#dim推定量">DiM推定量</a></li>
  <li><a href="#重回帰分析" id="toc-重回帰分析" class="nav-link" data-scroll-target="#重回帰分析">重回帰分析</a></li>
  </ul></li>
  <li><a href="#マッチング" id="toc-マッチング" class="nav-link" data-scroll-target="#マッチング">マッチング</a>
  <ul class="collapse">
  <li><a href="#最近傍マッチング" id="toc-最近傍マッチング" class="nav-link" data-scroll-target="#最近傍マッチング">最近傍マッチング</a></li>
  <li><a href="#傾向スコア" id="toc-傾向スコア" class="nav-link" data-scroll-target="#傾向スコア">傾向スコア</a></li>
  <li><a href="#cem" id="toc-cem" class="nav-link" data-scroll-target="#cem">CEM</a></li>
  </ul></li>
  <li><a href="#ipw" id="toc-ipw" class="nav-link" data-scroll-target="#ipw">IPW</a></li>
  <li><a href="#バランスチェック" id="toc-バランスチェック" class="nav-link" data-scroll-target="#バランスチェック">バランスチェック</a></li>
  <li><a href="#推定値の比較" id="toc-推定値の比較" class="nav-link" data-scroll-target="#推定値の比較">推定値の比較</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">回帰分析とマッチング</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<section id="スライド" class="level2">
<h2 class="anchored" data-anchor-id="スライド">スライド</h2>
<p><a href="../slide/matching.html" class="btn btn-primary btn-sm" target="_blank" role="button"><i class="bi bi-window"></i> 新しいタブで開く</a></p>
<iframe class="slide-deck" src="../slide/matching.html" width="100%" style="aspect-ratio: 16 / 9.2;"></iframe>
</section>
<section id="セットアップ" class="level2">
<h2 class="anchored" data-anchor-id="セットアップ">セットアップ</h2>
<p>　本日の実習で使用するパッケージを読み込む。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1"></a>pacman<span class="sc">::</span><span class="fu">p_load</span>(tidyverse, </span>
<span id="cb1-2"><a href="#cb1-2"></a>               broom,</span>
<span id="cb1-3"><a href="#cb1-3"></a>               MatchIt, </span>
<span id="cb1-4"><a href="#cb1-4"></a>               WeightIt, </span>
<span id="cb1-5"><a href="#cb1-5"></a>               cobalt, </span>
<span id="cb1-6"><a href="#cb1-6"></a>               summarytools,</span>
<span id="cb1-7"><a href="#cb1-7"></a>               modelsummary,</span>
<span id="cb1-8"><a href="#cb1-8"></a>               fastDummies)</span>
<span id="cb1-9"><a href="#cb1-9"></a>pacman<span class="sc">::</span><span class="fu">p_load_gh</span>(<span class="st">"JaehyunSong/BalanceR"</span>)</span></code><button title="コピー" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>　マッチングにおける古典的なデータセット、<code>lalonde</code>を読み込む。<code>data(lalonde, package = "cobalt")</code>を入力するだけで、{cobalt}パッケージ内の<code>laonde</code>という名前のデータフレームが作業環境内に<code>lalonde</code>という名で格納される<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a>。このデータを<code>la_df</code>という名のオブジェクトとして改めて保存しておこう。ただし、<code>lalonde</code>データセットの形式はdata.frameである。このままでも全く問題ないが、data.frameの拡張版であるtibble形式の方がより読みやすいので、格納する前に<code>lalonde</code>のデータ構造をdata.frameからtibbleへ変更しておこう（<code>as_tibble()</code>関数を使う）。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1"></a><span class="co"># cobaltパッケージが提供するデータセットの読み込み</span></span>
<span id="cb2-2"><a href="#cb2-2"></a><span class="fu">data</span>(<span class="st">"lalonde"</span>, <span class="at">package =</span> <span class="st">"cobalt"</span>)</span>
<span id="cb2-3"><a href="#cb2-3"></a></span>
<span id="cb2-4"><a href="#cb2-4"></a>la_df <span class="ot">&lt;-</span> <span class="fu">as_tibble</span>(lalonde)</span></code><button title="コピー" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>　それでは、データの中身を確認してみよう。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1"></a>la_df</span></code><button title="コピー" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 614 × 9
   treat   age  educ race   married nodegree  re74  re75   re78
   &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;fct&gt;    &lt;int&gt;    &lt;int&gt; &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt;
 1     1    37    11 black        1        1     0     0  9930.
 2     1    22     9 hispan       0        1     0     0  3596.
 3     1    30    12 black        0        0     0     0 24909.
 4     1    27    11 black        0        1     0     0  7506.
 5     1    33     8 black        0        1     0     0   290.
 6     1    22     9 black        0        1     0     0  4056.
 7     1    23    12 black        0        0     0     0     0 
 8     1    32    11 black        0        1     0     0  8472.
 9     1    22    16 black        0        0     0     0  2164.
10     1    33    12 white        1        0     0     0 12418.
# ℹ 604 more rows</code></pre>
</div>
</div>
<p>　分析に入る前に、名目変数である人種（<code>race</code>）をダミー変数に変換する。<code>race</code>は3種類の値で構成されているため、生成するダミー変数も3つとなる。ダミー化には{fastDummies}パッケージの<code>dummy_cols()</code>関数を使用する。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1"></a>la_df <span class="ot">&lt;-</span> la_df <span class="sc">|&gt;</span></span>
<span id="cb5-2"><a href="#cb5-2"></a>  <span class="fu">dummy_cols</span>(<span class="at">select_columns =</span> <span class="st">"race"</span>)</span>
<span id="cb5-3"><a href="#cb5-3"></a></span>
<span id="cb5-4"><a href="#cb5-4"></a>la_df</span></code><button title="コピー" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 614 × 12
   treat   age  educ race   married nodegree  re74  re75   re78 race_black
   &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;fct&gt;    &lt;int&gt;    &lt;int&gt; &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt;      &lt;int&gt;
 1     1    37    11 black        1        1     0     0  9930.          1
 2     1    22     9 hispan       0        1     0     0  3596.          0
 3     1    30    12 black        0        0     0     0 24909.          1
 4     1    27    11 black        0        1     0     0  7506.          1
 5     1    33     8 black        0        1     0     0   290.          1
 6     1    22     9 black        0        1     0     0  4056.          1
 7     1    23    12 black        0        0     0     0     0           1
 8     1    32    11 black        0        1     0     0  8472.          1
 9     1    22    16 black        0        0     0     0  2164.          1
10     1    33    12 white        1        0     0     0 12418.          0
# ℹ 604 more rows
# ℹ 2 more variables: race_hispan &lt;int&gt;, race_white &lt;int&gt;</code></pre>
</div>
</div>
<p>　このまま記述統計を見たり、分析に入っても良いが、もう少しデータを加工してみよう。まず<code>race_</code>で始まる3つのダミー変数の位置を<code>race</code>の前へ変更する。また、<code>race</code>変数は不要なので、<code>race</code>変数を除外する。最後に、<code>race_</code>で始まるダミー変数の名前を変更してみよう。変数の位置変更は<code>relocate()</code>関数を使用する。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1"></a>la_df <span class="ot">&lt;-</span> la_df <span class="sc">|&gt;</span></span>
<span id="cb7-2"><a href="#cb7-2"></a>  <span class="fu">relocate</span>(<span class="fu">starts_with</span>(<span class="st">"race_"</span>), <span class="at">.before =</span> race) <span class="sc">|&gt;</span></span>
<span id="cb7-3"><a href="#cb7-3"></a>  <span class="fu">select</span>(<span class="sc">-</span>race) <span class="sc">|&gt;</span></span>
<span id="cb7-4"><a href="#cb7-4"></a>  <span class="fu">rename</span>(<span class="st">"black"</span>    <span class="ot">=</span> <span class="st">"race_black"</span>,</span>
<span id="cb7-5"><a href="#cb7-5"></a>         <span class="st">"hispanic"</span> <span class="ot">=</span> <span class="st">"race_hispan"</span>,</span>
<span id="cb7-6"><a href="#cb7-6"></a>         <span class="st">"white"</span>    <span class="ot">=</span> <span class="st">"race_white"</span>)</span>
<span id="cb7-7"><a href="#cb7-7"></a></span>
<span id="cb7-8"><a href="#cb7-8"></a>la_df</span></code><button title="コピー" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 614 × 11
   treat   age  educ black hispanic white married nodegree  re74  re75   re78
   &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;int&gt;    &lt;int&gt; &lt;int&gt;   &lt;int&gt;    &lt;int&gt; &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt;
 1     1    37    11     1        0     0       1        1     0     0  9930.
 2     1    22     9     0        1     0       0        1     0     0  3596.
 3     1    30    12     1        0     0       0        0     0     0 24909.
 4     1    27    11     1        0     0       0        1     0     0  7506.
 5     1    33     8     1        0     0       0        1     0     0   290.
 6     1    22     9     1        0     0       0        1     0     0  4056.
 7     1    23    12     1        0     0       0        0     0     0     0 
 8     1    32    11     1        0     0       0        1     0     0  8472.
 9     1    22    16     1        0     0       0        0     0     0  2164.
10     1    33    12     0        0     1       1        0     0     0 12418.
# ℹ 604 more rows</code></pre>
</div>
</div>
<p>　それでは記述統計量を確認してみよう。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1"></a><span class="fu">descr</span>(la_df,</span>
<span id="cb9-2"><a href="#cb9-2"></a>      <span class="at">stats =</span> <span class="fu">c</span>(<span class="st">"mean"</span>, <span class="st">"sd"</span>, <span class="st">"min"</span>, <span class="st">"max"</span>),</span>
<span id="cb9-3"><a href="#cb9-3"></a>      <span class="at">transpose =</span> <span class="cn">TRUE</span>,</span>
<span id="cb9-4"><a href="#cb9-4"></a>      <span class="at">order =</span> <span class="st">"p"</span>)</span></code><button title="コピー" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-layout-align="center">
<table class="caption-top table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: right;">&nbsp;</th>
<th style="text-align: right;">Mean</th>
<th style="text-align: right;">Std.Dev</th>
<th style="text-align: right;">Min</th>
<th style="text-align: right;">Max</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: right;"><strong>treat</strong></td>
<td style="text-align: right;">0.30</td>
<td style="text-align: right;">0.46</td>
<td style="text-align: right;">0.00</td>
<td style="text-align: right;">1.00</td>
</tr>
<tr class="even">
<td style="text-align: right;"><strong>age</strong></td>
<td style="text-align: right;">27.36</td>
<td style="text-align: right;">9.88</td>
<td style="text-align: right;">16.00</td>
<td style="text-align: right;">55.00</td>
</tr>
<tr class="odd">
<td style="text-align: right;"><strong>educ</strong></td>
<td style="text-align: right;">10.27</td>
<td style="text-align: right;">2.63</td>
<td style="text-align: right;">0.00</td>
<td style="text-align: right;">18.00</td>
</tr>
<tr class="even">
<td style="text-align: right;"><strong>black</strong></td>
<td style="text-align: right;">0.40</td>
<td style="text-align: right;">0.49</td>
<td style="text-align: right;">0.00</td>
<td style="text-align: right;">1.00</td>
</tr>
<tr class="odd">
<td style="text-align: right;"><strong>hispanic</strong></td>
<td style="text-align: right;">0.12</td>
<td style="text-align: right;">0.32</td>
<td style="text-align: right;">0.00</td>
<td style="text-align: right;">1.00</td>
</tr>
<tr class="even">
<td style="text-align: right;"><strong>white</strong></td>
<td style="text-align: right;">0.49</td>
<td style="text-align: right;">0.50</td>
<td style="text-align: right;">0.00</td>
<td style="text-align: right;">1.00</td>
</tr>
<tr class="odd">
<td style="text-align: right;"><strong>married</strong></td>
<td style="text-align: right;">0.42</td>
<td style="text-align: right;">0.49</td>
<td style="text-align: right;">0.00</td>
<td style="text-align: right;">1.00</td>
</tr>
<tr class="even">
<td style="text-align: right;"><strong>nodegree</strong></td>
<td style="text-align: right;">0.63</td>
<td style="text-align: right;">0.48</td>
<td style="text-align: right;">0.00</td>
<td style="text-align: right;">1.00</td>
</tr>
<tr class="odd">
<td style="text-align: right;"><strong>re74</strong></td>
<td style="text-align: right;">4557.55</td>
<td style="text-align: right;">6477.96</td>
<td style="text-align: right;">0.00</td>
<td style="text-align: right;">35040.07</td>
</tr>
<tr class="even">
<td style="text-align: right;"><strong>re75</strong></td>
<td style="text-align: right;">2184.94</td>
<td style="text-align: right;">3295.68</td>
<td style="text-align: right;">0.00</td>
<td style="text-align: right;">25142.24</td>
</tr>
<tr class="odd">
<td style="text-align: right;"><strong>re78</strong></td>
<td style="text-align: right;">6792.83</td>
<td style="text-align: right;">7470.73</td>
<td style="text-align: right;">0.00</td>
<td style="text-align: right;">60307.93</td>
</tr>
</tbody>
</table>
</div>
</section>
<section id="回帰分析" class="level2">
<h2 class="anchored" data-anchor-id="回帰分析">回帰分析</h2>
<section id="dim推定量" class="level3">
<h3 class="anchored" data-anchor-id="dim推定量">DiM推定量</h3>
<p>　処置効果を確認するために、まずはグループごとの応答変数の差分（Difference-in-Means; DiM）を計算してみよう。処置変数は<code>treat</code>であり、職業訓練を受けた回答者は1、受けなかった回答者は0となる。応答変数<code>re78</code>は1978年における回答者の収入である。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1"></a>Diff_Mean_df <span class="ot">&lt;-</span> la_df <span class="sc">|&gt;</span> </span>
<span id="cb10-2"><a href="#cb10-2"></a>    <span class="fu">group_by</span>(treat) <span class="sc">|&gt;</span></span>
<span id="cb10-3"><a href="#cb10-3"></a>    <span class="fu">summarise</span>(<span class="at">Outcome =</span> <span class="fu">mean</span>(re78),</span>
<span id="cb10-4"><a href="#cb10-4"></a>              <span class="at">.groups =</span> <span class="st">"drop"</span>)</span>
<span id="cb10-5"><a href="#cb10-5"></a></span>
<span id="cb10-6"><a href="#cb10-6"></a>Diff_Mean_df</span></code><button title="コピー" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 2 × 2
  treat Outcome
  &lt;int&gt;   &lt;dbl&gt;
1     0   6984.
2     1   6349.</code></pre>
</div>
</div>
<p>　この結果を可視化する必要はあまり無いかも知れないが、以下のようなコードで可視化することもできる。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1"></a>Diff_Mean_df <span class="sc">|&gt;</span></span>
<span id="cb12-2"><a href="#cb12-2"></a>  <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb12-3"><a href="#cb12-3"></a>  <span class="fu">geom_bar</span>(<span class="fu">aes</span>(<span class="at">x =</span> treat, <span class="at">y =</span> Outcome), </span>
<span id="cb12-4"><a href="#cb12-4"></a>           <span class="at">stat =</span> <span class="st">"identity"</span>, <span class="at">width =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb12-5"><a href="#cb12-5"></a>  <span class="fu">geom_label</span>(<span class="fu">aes</span>(<span class="at">x =</span> treat, <span class="at">y =</span> Outcome,</span>
<span id="cb12-6"><a href="#cb12-6"></a>                 <span class="at">label =</span> <span class="fu">round</span>(Outcome, <span class="dv">3</span>))) <span class="sc">+</span></span>
<span id="cb12-7"><a href="#cb12-7"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Treatment"</span>,</span>
<span id="cb12-8"><a href="#cb12-8"></a>       <span class="at">y =</span> <span class="st">"Outcome (US Dollars)"</span>) <span class="sc">+</span></span>
<span id="cb12-9"><a href="#cb12-9"></a>  <span class="co"># scale_x_continuous()を使って0/1をControl/Treatmentに置換する</span></span>
<span id="cb12-10"><a href="#cb12-10"></a>  <span class="co"># 目盛りはX軸上の0と1、各目盛りのラベルはControlとTreatmentに</span></span>
<span id="cb12-11"><a href="#cb12-11"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">breaks =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>), <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"Control"</span>, <span class="st">"Treatment"</span>)) <span class="sc">+</span></span>
<span id="cb12-12"><a href="#cb12-12"></a>  <span class="fu">coord_cartesian</span>(<span class="at">xlim =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="fl">0.5</span>, <span class="fl">1.5</span>))</span></code><button title="コピー" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="matching_files/figure-html/unnamed-chunk-9-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="1050"></p>
</figure>
</div>
</div>
</div>
<p>　<code>treat == 0</code>の回答者、つまり職業訓練を受けていない回答者の平均所得は約6984ドル、<code>treat == 1</code>の回答者、つまり職業訓練を受けた回答者の平均所得は約6394ドルだ。その差は約-650ドルだが、職業訓練を受けた回答者の方が低所得になっている。これは直感的に納得できる結果ではないだろう。むろん、実際、職業訓練が所得を減らす可能性もあるが、今回の結果はより詳しく分析してみる価値があろう。</p>
<p>　ちなみに、以上の結果は単回帰分析からも確認できる (ただし、統計的に有意ではない)。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1"></a>DiM_fit <span class="ot">&lt;-</span> <span class="fu">lm</span>(re78 <span class="sc">~</span> treat, <span class="at">data =</span> la_df)</span>
<span id="cb13-2"><a href="#cb13-2"></a><span class="fu">modelsummary</span>(DiM_fit,</span>
<span id="cb13-3"><a href="#cb13-3"></a>             <span class="co"># 係数の点推定値と95%信頼区間を示す場合</span></span>
<span id="cb13-4"><a href="#cb13-4"></a>             <span class="at">estimate   =</span> <span class="st">"{estimate} [{conf.low}, {conf.high}]"</span>,</span>
<span id="cb13-5"><a href="#cb13-5"></a>             <span class="at">statistic  =</span> <span class="cn">NULL</span>,</span>
<span id="cb13-6"><a href="#cb13-6"></a>             <span class="at">conf_level =</span> <span class="fl">0.95</span>,</span>
<span id="cb13-7"><a href="#cb13-7"></a>             <span class="co"># ケース数、決定係数、調整済み決定係数を出力</span></span>
<span id="cb13-8"><a href="#cb13-8"></a>             <span class="at">gof_map    =</span> <span class="fu">c</span>(<span class="st">"nobs"</span>, <span class="st">"r.squared"</span>, <span class="st">"adj.r.squared"</span>))</span></code><button title="コピー" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<!-- preamble start -->

    <script>

      function styleCell_z66oyqicpp682x938vpf(i, j, css_id) {
          var table = document.getElementById("tinytable_z66oyqicpp682x938vpf");
          var cell = table.rows[i]?.cells[j];  // Safe navigation to avoid errors
          if (cell) {
              console.log(`Styling cell at (${i}, ${j}) with class ${css_id}`);
              cell.classList.add(css_id);
          } else {
              console.warn(`Cell at (${i}, ${j}) not found.`);
          }
      }
      function insertSpanRow(i, colspan, content) {
        var table = document.getElementById('tinytable_z66oyqicpp682x938vpf');
        var newRow = table.insertRow(i);
        var newCell = newRow.insertCell(0);
        newCell.setAttribute("colspan", colspan);
        // newCell.innerText = content;
        // this may be unsafe, but innerText does not interpret <br>
        newCell.innerHTML = content;
      }
      function spanCell_z66oyqicpp682x938vpf(i, j, rowspan, colspan) {
        var table = document.getElementById("tinytable_z66oyqicpp682x938vpf");
        const targetRow = table.rows[i];
        const targetCell = targetRow.cells[j];
        for (let r = 0; r < rowspan; r++) {
          // Only start deleting cells to the right for the first row (r == 0)
          if (r === 0) {
            // Delete cells to the right of the target cell in the first row
            for (let c = colspan - 1; c > 0; c--) {
              if (table.rows[i + r].cells[j + c]) {
                table.rows[i + r].deleteCell(j + c);
              }
            }
          }
          // For rows below the first, delete starting from the target column
          if (r > 0) {
            for (let c = colspan - 1; c >= 0; c--) {
              if (table.rows[i + r] && table.rows[i + r].cells[j]) {
                table.rows[i + r].deleteCell(j);
              }
            }
          }
        }
        // Set rowspan and colspan of the target cell
        targetCell.rowSpan = rowspan;
        targetCell.colSpan = colspan;
      }
      // tinytable span after
      window.addEventListener('load', function () {
          var cellsToStyle = [
            // tinytable style arrays after
          { positions: [ { i: 1, j: 0 }, { i: 3, j: 0 }, { i: 4, j: 0 },  ], css_id: 'tinytable_css_yhi5nymnsq04evvf8c0s',}, 
          { positions: [ { i: 0, j: 1 },  ], css_id: 'tinytable_css_nxr3i9xl9nk21o5clh5l',}, 
          { positions: [ { i: 0, j: 0 },  ], css_id: 'tinytable_css_lskqqzye05rlams8hu54',}, 
          { positions: [ { i: 2, j: 0 },  ], css_id: 'tinytable_css_kac18jvhw3m99qumydjv',}, 
          { positions: [ { i: 5, j: 0 },  ], css_id: 'tinytable_css_9f6xm7cil4mgrucu84m8',}, 
          { positions: [ { i: 5, j: 1 },  ], css_id: 'tinytable_css_5cfgo8kqx5fawcebhloz',}, 
          { positions: [ { i: 1, j: 1 }, { i: 3, j: 1 }, { i: 4, j: 1 },  ], css_id: 'tinytable_css_2m9pue6xz3nuomdzarnj',}, 
          { positions: [ { i: 2, j: 1 },  ], css_id: 'tinytable_css_1bhkkfzrd0sjb8lvq2t0',}, 
          ];

          // Loop over the arrays to style the cells
          cellsToStyle.forEach(function (group) {
              group.positions.forEach(function (cell) {
                  styleCell_z66oyqicpp682x938vpf(cell.i, cell.j, group.css_id);
              });
          });
      });
    </script>

    <style>
      /* tinytable css entries after */
      .table td.tinytable_css_yhi5nymnsq04evvf8c0s, .table th.tinytable_css_yhi5nymnsq04evvf8c0s { text-align: left; }
      .table td.tinytable_css_nxr3i9xl9nk21o5clh5l, .table th.tinytable_css_nxr3i9xl9nk21o5clh5l { text-align: center; border-top: solid #d3d8dc 0.1em; border-bottom: solid #d3d8dc 0.05em; }
      .table td.tinytable_css_lskqqzye05rlams8hu54, .table th.tinytable_css_lskqqzye05rlams8hu54 { text-align: left; border-top: solid #d3d8dc 0.1em; border-bottom: solid #d3d8dc 0.05em; }
      .table td.tinytable_css_kac18jvhw3m99qumydjv, .table th.tinytable_css_kac18jvhw3m99qumydjv { text-align: left; border-bottom: solid black 0.05em; }
      .table td.tinytable_css_9f6xm7cil4mgrucu84m8, .table th.tinytable_css_9f6xm7cil4mgrucu84m8 { text-align: left; border-bottom: solid #d3d8dc 0.1em; }
      .table td.tinytable_css_5cfgo8kqx5fawcebhloz, .table th.tinytable_css_5cfgo8kqx5fawcebhloz { text-align: center; border-bottom: solid #d3d8dc 0.1em; }
      .table td.tinytable_css_2m9pue6xz3nuomdzarnj, .table th.tinytable_css_2m9pue6xz3nuomdzarnj { text-align: center; }
      .table td.tinytable_css_1bhkkfzrd0sjb8lvq2t0, .table th.tinytable_css_1bhkkfzrd0sjb8lvq2t0 { text-align: center; border-bottom: solid black 0.05em; }
    </style>
    <div class="container">
      <table class="table table-borderless" id="tinytable_z66oyqicpp682x938vpf" style="width: auto; margin-left: auto; margin-right: auto;" data-quarto-disable-processing="true">
        <thead>
        
              <tr>
                <th scope="col"> </th>
                <th scope="col">(1)</th>
              </tr>
        </thead>
        
        <tbody>
                <tr>
                  <td>(Intercept)</td>
                  <td>6984.170 [6275.791, 7692.549]</td>
                </tr>
                <tr>
                  <td>treat</td>
                  <td>-635.026 [-1925.544, 655.492]</td>
                </tr>
                <tr>
                  <td>Num.Obs.</td>
                  <td>614</td>
                </tr>
                <tr>
                  <td>R2</td>
                  <td>0.002</td>
                </tr>
                <tr>
                  <td>R2 Adj.</td>
                  <td>-0.000</td>
                </tr>
        </tbody>
      </table>
    </div>
<!-- hack to avoid NA insertion in last line -->
</div>
</div>
<p>　この直感的でない結果は、もしかしたらセレクションバイアスが原因かも知れない。職業訓練の対象が元々非常に所得が低い回答者になっている可能性がある。たとえば、下の図のように職業訓練の有無が教育水準や人種、これまでの所得などと関係しているとしよう。これらの要因は回答者の現在所得にも関係していると考えられる。この場合、処置有無と所得の間には内生性が存在することになる。</p>
<div class="cell" data-layout-align="center">
<details class="code-fold">
<summary>作図用のコード</summary>
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1"></a>pacman<span class="sc">::</span><span class="fu">p_load</span>(ggdag)</span>
<span id="cb14-2"><a href="#cb14-2"></a><span class="fu">dagify</span>(Income <span class="sc">~</span> Race <span class="sc">+</span> Training <span class="sc">+</span> Educ,</span>
<span id="cb14-3"><a href="#cb14-3"></a>       Training <span class="sc">~</span> Race <span class="sc">+</span> Educ,</span>
<span id="cb14-4"><a href="#cb14-4"></a>       <span class="at">exposure =</span> <span class="st">"Training"</span>,</span>
<span id="cb14-5"><a href="#cb14-5"></a>       <span class="at">outcome  =</span> <span class="st">"Income"</span>,</span>
<span id="cb14-6"><a href="#cb14-6"></a>       <span class="at">coords   =</span> <span class="fu">list</span>(</span>
<span id="cb14-7"><a href="#cb14-7"></a>         <span class="at">x =</span> <span class="fu">c</span>(<span class="at">Race =</span> <span class="fl">1.5</span>, <span class="at">Educ =</span> <span class="fl">2.5</span>, <span class="at">Training =</span> <span class="dv">1</span>, <span class="at">Income =</span> <span class="dv">3</span>),</span>
<span id="cb14-8"><a href="#cb14-8"></a>         <span class="at">y =</span> <span class="fu">c</span>(<span class="at">Race =</span> <span class="dv">2</span>,   <span class="at">Educ =</span> <span class="dv">2</span>,   <span class="at">Training =</span> <span class="dv">1</span>, <span class="at">Income =</span> <span class="dv">1</span>)</span>
<span id="cb14-9"><a href="#cb14-9"></a>       )</span>
<span id="cb14-10"><a href="#cb14-10"></a>       ) <span class="sc">|&gt;</span></span>
<span id="cb14-11"><a href="#cb14-11"></a>  <span class="fu">tidy_dagitty</span>() <span class="sc">|&gt;</span></span>
<span id="cb14-12"><a href="#cb14-12"></a>  <span class="fu">ggdag</span>(<span class="fu">confounder_triangle</span>(), <span class="at">node_size =</span> <span class="dv">20</span>) <span class="sc">+</span></span>
<span id="cb14-13"><a href="#cb14-13"></a>  <span class="fu">coord_cartesian</span>(<span class="at">xlim =</span> <span class="fu">c</span>(<span class="fl">0.8</span>, <span class="fl">3.2</span>), <span class="at">ylim =</span> <span class="fu">c</span>(<span class="fl">0.8</span>, <span class="fl">2.2</span>)) <span class="sc">+</span></span>
<span id="cb14-14"><a href="#cb14-14"></a>  <span class="fu">theme_dag_blank</span>()</span></code><button title="コピー" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="matching_files/figure-html/unnamed-chunk-11-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="750"></p>
</figure>
</div>
</div>
</div>
<p>　本当にそうなのかを、共変量のバランスチェックをしてみよう。もし、処置有無によって回答者の社会経済的要因に大きな差があれば、内生性が存在する証拠になろう。ここでは<a href="https://www.jaysong.net">誰か</a>が作成しました{BalanceR}パッケージを使ってみよう。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1"></a>blc_chk <span class="ot">&lt;-</span> la_df <span class="sc">|&gt;</span></span>
<span id="cb15-2"><a href="#cb15-2"></a>  <span class="fu">BalanceR</span>(<span class="at">group =</span> treat, <span class="at">cov =</span> age<span class="sc">:</span>re75)</span></code><button title="コピー" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>　{BalanceR}パッケージで共変量を指定する際、<code>:</code>演算子が使える。<code>age:re75</code>は、データセットの<code>age</code>から<code>re75</code>変数までをすべて指定することを意味する。<code>names(la_df)</code>で変数がどの順番で並んでいるかが分かる。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1"></a><span class="fu">names</span>(la_df)</span></code><button title="コピー" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> [1] "treat"    "age"      "educ"     "black"    "hispanic" "white"   
 [7] "married"  "nodegree" "re74"     "re75"     "re78"    </code></pre>
</div>
</div>
<p>　それではバランスチェックの結果を確認してみよう。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1"></a>blc_chk</span></code><button title="コピー" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  Covariate   Mean:0     SD:0   Mean:1     SD:1   SB:0-1
1       age   28.030   10.787   25.816    7.155   24.190
2      educ   10.235    2.855   10.346    2.011   -4.476
3     black    0.203    0.403    0.843    0.365 -167.083
4  hispanic    0.142    0.350    0.059    0.237   27.740
5     white    0.655    0.476    0.097    0.297  140.799
6   married    0.513    0.500    0.189    0.393   72.076
7  nodegree    0.597    0.491    0.708    0.456  -23.549
8      re74 5619.237 6788.751 2095.574 4886.620   59.575
9      re75 2466.484 3291.996 1532.055 3219.251   28.700</code></pre>
</div>
</div>
<p>　アンバランスと判定する標準化差分（標準化バイアス）の閾値には決まった値が無いが、最も緩い基準でも25程度である（計算時に100を掛けないのであれば0.25）。しかし、いくつか怪しい箇所がある。たとえば、<code>treat == 0</code>の回答者において黒人の割合は約20%だが、<code>treat == 1</code>のそれは約85%だ。つまり、黒人ほどより職業訓練を受ける傾向があることを意味する。また、人種は所得にも影響を与えると考えられる。これは処置と応答変数の間に交絡要因があることを意味する。実際、標準化バイアスは-167という、非常に大きい数値を示している。この結果を図としてまとめてみましょう。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1"></a><span class="co"># 絶対値変換。SB = 25に破線</span></span>
<span id="cb20-2"><a href="#cb20-2"></a><span class="fu">plot</span>(blc_chk, <span class="at">abs =</span> <span class="cn">TRUE</span>, <span class="at">vline =</span> <span class="dv">25</span>) <span class="sc">+</span></span>
<span id="cb20-3"><a href="#cb20-3"></a>  <span class="co"># 縦軸目盛りラベルの修正</span></span>
<span id="cb20-4"><a href="#cb20-4"></a>  <span class="fu">scale_y_discrete</span>(<span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"age"</span>      <span class="ot">=</span> <span class="st">"Age"</span>,</span>
<span id="cb20-5"><a href="#cb20-5"></a>                              <span class="st">"educ"</span>     <span class="ot">=</span> <span class="st">"Education"</span>,</span>
<span id="cb20-6"><a href="#cb20-6"></a>                              <span class="st">"black"</span>    <span class="ot">=</span> <span class="st">"Race (Black)"</span>,</span>
<span id="cb20-7"><a href="#cb20-7"></a>                              <span class="st">"hispanic"</span> <span class="ot">=</span> <span class="st">"Race (Hispanic)"</span>,</span>
<span id="cb20-8"><a href="#cb20-8"></a>                              <span class="st">"white"</span>    <span class="ot">=</span> <span class="st">"Race (White)"</span>,</span>
<span id="cb20-9"><a href="#cb20-9"></a>                              <span class="st">"married"</span>  <span class="ot">=</span> <span class="st">"Married"</span>,</span>
<span id="cb20-10"><a href="#cb20-10"></a>                              <span class="st">"nodegree"</span> <span class="ot">=</span> <span class="st">"No Degree"</span>,</span>
<span id="cb20-11"><a href="#cb20-11"></a>                              <span class="st">"re74"</span>     <span class="ot">=</span> <span class="st">"Revenue (1974)"</span>,</span>
<span id="cb20-12"><a href="#cb20-12"></a>                              <span class="st">"re75"</span>     <span class="ot">=</span> <span class="st">"Revenue (1975)"</span>)) <span class="sc">+</span></span>
<span id="cb20-13"><a href="#cb20-13"></a>  <span class="co"># 凡例の削除</span></span>
<span id="cb20-14"><a href="#cb20-14"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"none"</span>)</span></code><button title="コピー" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="matching_files/figure-html/unnamed-chunk-15-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="1050"></p>
</figure>
</div>
</div>
</div>
<p>　かなり緩めの基準である25を採用しても、人種、結婚有無、74・75年の所得のバランスが非常に悪く、内生性（=自己選択バイアス）があると判断して良いだろう。以下ではこの内生性に対処する様々な方法を紹介する。</p>
</section>
<section id="重回帰分析" class="level3">
<h3 class="anchored" data-anchor-id="重回帰分析">重回帰分析</h3>
<p>　まずは、重回帰分析からだ。用いる共変量は年齢、教育水準、黒人ダミー、ヒスパニックダミー<a href="#fn2" class="footnote-ref" id="fnref2" role="doc-noteref"><sup>2</sup></a>、既婚ダミー、学位なしダミー、74・75年の所得だ。<code>lm()</code>関数で78年の所得をこちらの変数に回帰させてみよう。</p>
<p><span class="math display">\[
\begin{align}
\widehat{\mbox{re78}} = &amp; \beta_0 + \beta_1 \mbox{treat} + \beta_2 \mbox{age} + \beta_3 \mbox{educ} + \\
&amp; \beta_4 \mbox{black} + \beta_5 \mbox{hispanic} + \beta_6 \mbox{married} + \beta_7 \mbox{nodegree} + \beta_8 \mbox{re74} + \beta_9 \mbox{re75}.
\end{align}
\]</span></p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1"></a>mlm_fit <span class="ot">&lt;-</span> <span class="fu">lm</span>(re78 <span class="sc">~</span> treat <span class="sc">+</span> age <span class="sc">+</span> educ <span class="sc">+</span> black <span class="sc">+</span> hispanic <span class="sc">+</span> married <span class="sc">+</span> </span>
<span id="cb21-2"><a href="#cb21-2"></a>                   nodegree <span class="sc">+</span> re74 <span class="sc">+</span> re75, <span class="at">data =</span> la_df)</span>
<span id="cb21-3"><a href="#cb21-3"></a></span>
<span id="cb21-4"><a href="#cb21-4"></a><span class="fu">modelsummary</span>(<span class="fu">list</span>(<span class="st">"単回帰分析"</span> <span class="ot">=</span> DiM_fit, <span class="st">"重回帰分析"</span> <span class="ot">=</span> mlm_fit), </span>
<span id="cb21-5"><a href="#cb21-5"></a>             <span class="at">estimate  =</span> <span class="st">"{estimate} ({std.error})"</span>,</span>
<span id="cb21-6"><a href="#cb21-6"></a>             <span class="at">statistic =</span> <span class="cn">NULL</span>,</span>
<span id="cb21-7"><a href="#cb21-7"></a>             <span class="at">gof_map   =</span> <span class="fu">c</span>(<span class="st">"nobs"</span>, <span class="st">"r.squared"</span>, <span class="st">"adj.r.squared"</span>))</span></code><button title="コピー" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<!-- preamble start -->

    <script>

      function styleCell_z8o5wubrx8y8f9bsmuvk(i, j, css_id) {
          var table = document.getElementById("tinytable_z8o5wubrx8y8f9bsmuvk");
          var cell = table.rows[i]?.cells[j];  // Safe navigation to avoid errors
          if (cell) {
              console.log(`Styling cell at (${i}, ${j}) with class ${css_id}`);
              cell.classList.add(css_id);
          } else {
              console.warn(`Cell at (${i}, ${j}) not found.`);
          }
      }
      function insertSpanRow(i, colspan, content) {
        var table = document.getElementById('tinytable_z8o5wubrx8y8f9bsmuvk');
        var newRow = table.insertRow(i);
        var newCell = newRow.insertCell(0);
        newCell.setAttribute("colspan", colspan);
        // newCell.innerText = content;
        // this may be unsafe, but innerText does not interpret <br>
        newCell.innerHTML = content;
      }
      function spanCell_z8o5wubrx8y8f9bsmuvk(i, j, rowspan, colspan) {
        var table = document.getElementById("tinytable_z8o5wubrx8y8f9bsmuvk");
        const targetRow = table.rows[i];
        const targetCell = targetRow.cells[j];
        for (let r = 0; r < rowspan; r++) {
          // Only start deleting cells to the right for the first row (r == 0)
          if (r === 0) {
            // Delete cells to the right of the target cell in the first row
            for (let c = colspan - 1; c > 0; c--) {
              if (table.rows[i + r].cells[j + c]) {
                table.rows[i + r].deleteCell(j + c);
              }
            }
          }
          // For rows below the first, delete starting from the target column
          if (r > 0) {
            for (let c = colspan - 1; c >= 0; c--) {
              if (table.rows[i + r] && table.rows[i + r].cells[j]) {
                table.rows[i + r].deleteCell(j);
              }
            }
          }
        }
        // Set rowspan and colspan of the target cell
        targetCell.rowSpan = rowspan;
        targetCell.colSpan = colspan;
      }
      // tinytable span after
      window.addEventListener('load', function () {
          var cellsToStyle = [
            // tinytable style arrays after
          { positions: [ { i: 0, j: 0 },  ], css_id: 'tinytable_css_zbdhgpnspwnt8p4o3hsv',}, 
          { positions: [ { i: 10, j: 0 },  ], css_id: 'tinytable_css_lu4l6n74eorfa71tn6qk',}, 
          { positions: [ { i: 13, j: 1 }, { i: 13, j: 2 },  ], css_id: 'tinytable_css_j6ku71dqis2jl1mp9ibc',}, 
          { positions: [ { i: 13, j: 0 },  ], css_id: 'tinytable_css_eeh2az7pndoag37v02ts',}, 
          { positions: [ { i: 0, j: 1 }, { i: 0, j: 2 },  ], css_id: 'tinytable_css_du0mogatp6nywra92aip',}, 
          { positions: [ { i: 10, j: 1 }, { i: 10, j: 2 },  ], css_id: 'tinytable_css_7yg9h98qbi4sn8f8nrtc',}, 
          { positions: [ { i: 2, j: 1 }, { i: 3, j: 1 }, { i: 4, j: 1 }, { i: 5, j: 1 }, { i: 6, j: 1 }, { i: 7, j: 1 }, { i: 8, j: 1 }, { i: 9, j: 1 }, { i: 9, j: 2 }, { i: 11, j: 1 }, { i: 12, j: 1 }, { i: 12, j: 2 }, { i: 1, j: 1 }, { i: 1, j: 2 }, { i: 2, j: 2 }, { i: 3, j: 2 }, { i: 4, j: 2 }, { i: 5, j: 2 }, { i: 6, j: 2 }, { i: 7, j: 2 }, { i: 8, j: 2 }, { i: 11, j: 2 },  ], css_id: 'tinytable_css_5vvbu65ygsmvrft0yway',}, 
          { positions: [ { i: 1, j: 0 }, { i: 2, j: 0 }, { i: 3, j: 0 }, { i: 4, j: 0 }, { i: 5, j: 0 }, { i: 6, j: 0 }, { i: 7, j: 0 }, { i: 8, j: 0 }, { i: 9, j: 0 }, { i: 11, j: 0 }, { i: 12, j: 0 },  ], css_id: 'tinytable_css_3xft1r3f0p84kfrlwi9z',}, 
          ];

          // Loop over the arrays to style the cells
          cellsToStyle.forEach(function (group) {
              group.positions.forEach(function (cell) {
                  styleCell_z8o5wubrx8y8f9bsmuvk(cell.i, cell.j, group.css_id);
              });
          });
      });
    </script>

    <style>
      /* tinytable css entries after */
      .table td.tinytable_css_zbdhgpnspwnt8p4o3hsv, .table th.tinytable_css_zbdhgpnspwnt8p4o3hsv { text-align: left; border-top: solid #d3d8dc 0.1em; border-bottom: solid #d3d8dc 0.05em; }
      .table td.tinytable_css_lu4l6n74eorfa71tn6qk, .table th.tinytable_css_lu4l6n74eorfa71tn6qk { text-align: left; border-bottom: solid black 0.05em; }
      .table td.tinytable_css_j6ku71dqis2jl1mp9ibc, .table th.tinytable_css_j6ku71dqis2jl1mp9ibc { text-align: center; border-bottom: solid #d3d8dc 0.1em; }
      .table td.tinytable_css_eeh2az7pndoag37v02ts, .table th.tinytable_css_eeh2az7pndoag37v02ts { text-align: left; border-bottom: solid #d3d8dc 0.1em; }
      .table td.tinytable_css_du0mogatp6nywra92aip, .table th.tinytable_css_du0mogatp6nywra92aip { text-align: center; border-top: solid #d3d8dc 0.1em; border-bottom: solid #d3d8dc 0.05em; }
      .table td.tinytable_css_7yg9h98qbi4sn8f8nrtc, .table th.tinytable_css_7yg9h98qbi4sn8f8nrtc { text-align: center; border-bottom: solid black 0.05em; }
      .table td.tinytable_css_5vvbu65ygsmvrft0yway, .table th.tinytable_css_5vvbu65ygsmvrft0yway { text-align: center; }
      .table td.tinytable_css_3xft1r3f0p84kfrlwi9z, .table th.tinytable_css_3xft1r3f0p84kfrlwi9z { text-align: left; }
    </style>
    <div class="container">
      <table class="table table-borderless" id="tinytable_z8o5wubrx8y8f9bsmuvk" style="width: auto; margin-left: auto; margin-right: auto;" data-quarto-disable-processing="true">
        <thead>
        
              <tr>
                <th scope="col"> </th>
                <th scope="col">単回帰分析</th>
                <th scope="col">重回帰分析</th>
              </tr>
        </thead>
        
        <tbody>
                <tr>
                  <td>(Intercept)</td>
                  <td>6984.170 (360.710)</td>
                  <td>66.515 (2436.746)</td>
                </tr>
                <tr>
                  <td>treat</td>
                  <td>-635.026 (657.137)</td>
                  <td>1548.244 (781.279)</td>
                </tr>
                <tr>
                  <td>age</td>
                  <td></td>
                  <td>12.978 (32.489)</td>
                </tr>
                <tr>
                  <td>educ</td>
                  <td></td>
                  <td>403.941 (158.906)</td>
                </tr>
                <tr>
                  <td>black</td>
                  <td></td>
                  <td>-1240.644 (768.764)</td>
                </tr>
                <tr>
                  <td>hispanic</td>
                  <td></td>
                  <td>498.897 (941.943)</td>
                </tr>
                <tr>
                  <td>married</td>
                  <td></td>
                  <td>406.621 (695.472)</td>
                </tr>
                <tr>
                  <td>nodegree</td>
                  <td></td>
                  <td>259.817 (847.442)</td>
                </tr>
                <tr>
                  <td>re74</td>
                  <td></td>
                  <td>0.296 (0.058)</td>
                </tr>
                <tr>
                  <td>re75</td>
                  <td></td>
                  <td>0.232 (0.105)</td>
                </tr>
                <tr>
                  <td>Num.Obs.</td>
                  <td>614</td>
                  <td>614</td>
                </tr>
                <tr>
                  <td>R2</td>
                  <td>0.002</td>
                  <td>0.148</td>
                </tr>
                <tr>
                  <td>R2 Adj.</td>
                  <td>-0.000</td>
                  <td>0.135</td>
                </tr>
        </tbody>
      </table>
    </div>
<!-- hack to avoid NA insertion in last line -->
</div>
</div>
<p>　共変量を統制したら処置変数の係数は約1548.244ドルだ。単回帰分析の結果とは違って、統計的に有意な正の効果が確認されている。ますます分からなくなってしまう。</p>
</section>
</section>
<section id="マッチング" class="level2">
<h2 class="anchored" data-anchor-id="マッチング">マッチング</h2>
<section id="最近傍マッチング" class="level3">
<h3 class="anchored" data-anchor-id="最近傍マッチング">最近傍マッチング</h3>
<p>　重回帰分析は非常にシンプルで便利な分析方法ですが、いくつかの欠点がある。まず、重回帰分析は変数間の関係（線形結合）および誤差項の分布（平均0の正規分布）などを仮定したパラメトリック分析ということだ。この場合、同じ共変量を持たないケースであっても、勝手に予測を行うこととなる。重回帰分析における処置変数の解釈は「他の共変量がすべて同じ」場合の処置効果である。これは、共変量がすべて同じ場合における（最初に見た）単純差分のようなものである。しかし、「他の共変量がすべて同じ」ケースが存在しない可能性があろう。特に、共変量が多く、連続変数の場合、共変量がすべて同じことは実質あり得ないか、非常に少ないケースに限定されることもある。一方、マッチングを行うと、「他の共変量がすべて同じ」、または「非常に似ている」ケース間で比較を行うことになる。</p>
<p>　本資料では以下の3つのマッチング手法の実装方法について解説する。</p>
<ol type="1">
<li>最近傍マッチング（マハラノビス距離）</li>
<li>最近傍マッチング（傾向スコア）</li>
<li>Coarsened Exact Matching (CEM)</li>
</ol>
<p>　まずは、マハラノビス距離を用いた最近傍マッチングから始めよう。だいたいのマッチング手法は{MatchIt}パッケージで解決できる。マッチングデータセットを作成する関数は<code>matchit()</code>関数であり、使い方は以下の通りである。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1"></a><span class="fu">matchit</span>(処置変数 <span class="sc">~</span> 共変量1 <span class="sc">+</span> ... <span class="sc">+</span> 共変量k, </span>
<span id="cb22-2"><a href="#cb22-2"></a>            <span class="at">data =</span> データフレーム名, <span class="at">estimand =</span> <span class="st">"ATT"</span>,</span>
<span id="cb22-3"><a href="#cb22-3"></a>            <span class="at">method =</span> <span class="st">"nearest"</span>, <span class="at">distance =</span> <span class="st">"mahalanobis"</span>)</span></code><button title="コピー" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>　<code>method = "nearest"</code>は最近傍マッチングを、<code>distance = "mahalanobis"</code>はマハラノビス距離を意味する。<code>estimand = "ATT"</code>はAT<strong>T</strong>を推定することを意味する。{MatchIt}の最近傍マッチングの場合、<code>"ATT"</code>、または<code>"ATC"</code>のみ指定可能である（後で紹介するCEMでは<code>"ATE"</code>も指定可能）。早速やってみよう。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1"></a>mh_mat1 <span class="ot">&lt;-</span> <span class="fu">matchit</span>(treat <span class="sc">~</span> age <span class="sc">+</span> educ <span class="sc">+</span> black <span class="sc">+</span> hispanic <span class="sc">+</span> married <span class="sc">+</span> </span>
<span id="cb23-2"><a href="#cb23-2"></a>                     nodegree <span class="sc">+</span> re74 <span class="sc">+</span> re75, </span>
<span id="cb23-3"><a href="#cb23-3"></a>                   <span class="at">data =</span> la_df, <span class="at">estimand =</span> <span class="st">"ATT"</span>,</span>
<span id="cb23-4"><a href="#cb23-4"></a>                   <span class="at">method =</span> <span class="st">"nearest"</span>, <span class="at">distance =</span> <span class="st">"mahalanobis"</span>)</span></code><button title="コピー" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>　マッチング後のデータでバランスが取れているかを確認するためにはいくつかの方法があるが、ここでは{cobalt}パッケージを使って、標準化差分を確認してみよう。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1"></a><span class="fu">love.plot</span>(mh_mat1, <span class="at">thresholds =</span> <span class="fl">0.25</span>, <span class="at">abs =</span> <span class="cn">TRUE</span>)</span></code><button title="コピー" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="matching_files/figure-html/unnamed-chunk-19-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="1050"></p>
</figure>
</div>
</div>
</div>
<p>　<code>thresholds</code>引数は垂直線（破線）の位置、<code>abs</code>は標準化差分を絶対値で示すことを意味する。マッチング後の標準化差分（Adjusted; 赤い点）が0.25より左側に位置している場合、バランスしていると判断できる<a href="#fn3" class="footnote-ref" id="fnref3" role="doc-noteref"><sup>3</sup></a>。むろん、より厳格な基準として0.03、0.05、0.1を使うこともできる。他にもマッチング後の標準化差分がマッチング前（Unadjusted; 青い点）より改善されるいるか否かも判断できる。今回の例だと、大幅にバランスが改善されている。0.25を基準とした場合、<code>black</code>はまだバランスが取れていないが、それでも大幅に改善されていることが分かる。</p>
<p>　それではAT<strong>T</strong>を推定してみよう。推定方法としてはノンパラメトリックな方法とパラメトリック方法があるが、結果は変わらない。ノンパラメトリックな方法はペアごとの差分を計算し、その平均値を求める方法だが、マッチング済みのデータに対し、処置変数を結果変数を回帰させることも、結果的には同じことを行うことになる。したがって、もっと簡単なパラメトリック方法、つまり単回帰分析でAT<strong>T</strong>を推定しよう。</p>
<p>　回帰分析を行うためにはデータが必要だ。つまり、マッチングされないケースをデータから除去する必要がある。ここでは<code>match.data()</code>関数を使ったマッチングされたケースのみを抽出してみよう。抽出したデータは<code>mh_data1</code>と名付ける。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1"></a>mh_data1 <span class="ot">&lt;-</span> <span class="fu">match.data</span>(mh_mat1)</span></code><button title="コピー" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>マッチングデータが取れたら、その中身を確認してみましょう。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1"></a>mh_data1</span></code><button title="コピー" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 370 × 13
   treat   age  educ black hispanic white married nodegree  re74  re75   re78
   &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;int&gt;    &lt;int&gt; &lt;int&gt;   &lt;int&gt;    &lt;int&gt; &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt;
 1     1    37    11     1        0     0       1        1     0     0  9930.
 2     1    22     9     0        1     0       0        1     0     0  3596.
 3     1    30    12     1        0     0       0        0     0     0 24909.
 4     1    27    11     1        0     0       0        1     0     0  7506.
 5     1    33     8     1        0     0       0        1     0     0   290.
 6     1    22     9     1        0     0       0        1     0     0  4056.
 7     1    23    12     1        0     0       0        0     0     0     0 
 8     1    32    11     1        0     0       0        1     0     0  8472.
 9     1    22    16     1        0     0       0        0     0     0  2164.
10     1    33    12     0        0     1       1        0     0     0 12418.
# ℹ 360 more rows
# ℹ 2 more variables: weights &lt;dbl&gt;, subclass &lt;fct&gt;</code></pre>
</div>
</div>
<p>　データのサイズは370行14列であり、この370行には意味がある。それは処置群の大きさの2倍という点だ。多くの場合、マッチングから計算される処置効果はATEではなく、ATTである。したがって、処置群のデータを100%活用し、共変量（のマハラノビス距離）が最も近いケースを統制群から抽出&amp;マッチングすることになる。だから、マッチング後のサンプルサイズは処置群のサイズの2倍になる。</p>
<p>　それでは職業訓練のAT<strong>T</strong>を推定してみよう。方法は簡単だ。マッチング後のデータ（<code>mh_data1</code>）を用い、単回帰分析を行うだけである。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1"></a>mh_fit1 <span class="ot">&lt;-</span> <span class="fu">lm</span>(re78 <span class="sc">~</span> treat, <span class="at">data =</span> mh_data1)</span>
<span id="cb28-2"><a href="#cb28-2"></a></span>
<span id="cb28-3"><a href="#cb28-3"></a><span class="fu">modelsummary</span>(mh_fit1)</span></code><button title="コピー" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<!-- preamble start -->

    <script>

      function styleCell_5t3ts6jjucs8t0pj075h(i, j, css_id) {
          var table = document.getElementById("tinytable_5t3ts6jjucs8t0pj075h");
          var cell = table.rows[i]?.cells[j];  // Safe navigation to avoid errors
          if (cell) {
              console.log(`Styling cell at (${i}, ${j}) with class ${css_id}`);
              cell.classList.add(css_id);
          } else {
              console.warn(`Cell at (${i}, ${j}) not found.`);
          }
      }
      function insertSpanRow(i, colspan, content) {
        var table = document.getElementById('tinytable_5t3ts6jjucs8t0pj075h');
        var newRow = table.insertRow(i);
        var newCell = newRow.insertCell(0);
        newCell.setAttribute("colspan", colspan);
        // newCell.innerText = content;
        // this may be unsafe, but innerText does not interpret <br>
        newCell.innerHTML = content;
      }
      function spanCell_5t3ts6jjucs8t0pj075h(i, j, rowspan, colspan) {
        var table = document.getElementById("tinytable_5t3ts6jjucs8t0pj075h");
        const targetRow = table.rows[i];
        const targetCell = targetRow.cells[j];
        for (let r = 0; r < rowspan; r++) {
          // Only start deleting cells to the right for the first row (r == 0)
          if (r === 0) {
            // Delete cells to the right of the target cell in the first row
            for (let c = colspan - 1; c > 0; c--) {
              if (table.rows[i + r].cells[j + c]) {
                table.rows[i + r].deleteCell(j + c);
              }
            }
          }
          // For rows below the first, delete starting from the target column
          if (r > 0) {
            for (let c = colspan - 1; c >= 0; c--) {
              if (table.rows[i + r] && table.rows[i + r].cells[j]) {
                table.rows[i + r].deleteCell(j);
              }
            }
          }
        }
        // Set rowspan and colspan of the target cell
        targetCell.rowSpan = rowspan;
        targetCell.colSpan = colspan;
      }
      // tinytable span after
      window.addEventListener('load', function () {
          var cellsToStyle = [
            // tinytable style arrays after
          { positions: [ { i: 0, j: 0 },  ], css_id: 'tinytable_css_zx3uq11l6ox1ydix9qwu',}, 
          { positions: [ { i: 4, j: 1 },  ], css_id: 'tinytable_css_xj1wtis0fcvmkorwvgyt',}, 
          { positions: [ { i: 1, j: 0 }, { i: 2, j: 0 }, { i: 3, j: 0 }, { i: 8, j: 0 }, { i: 5, j: 0 }, { i: 6, j: 0 }, { i: 7, j: 0 }, { i: 9, j: 0 }, { i: 10, j: 0 }, { i: 11, j: 0 },  ], css_id: 'tinytable_css_rd7zqmmncav25mujhvp9',}, 
          { positions: [ { i: 12, j: 1 },  ], css_id: 'tinytable_css_r9jar2ithqdu9cnp6zlh',}, 
          { positions: [ { i: 4, j: 0 },  ], css_id: 'tinytable_css_dum0cwpu1wxh10nuy02x',}, 
          { positions: [ { i: 1, j: 1 }, { i: 2, j: 1 }, { i: 3, j: 1 }, { i: 8, j: 1 }, { i: 5, j: 1 }, { i: 6, j: 1 }, { i: 7, j: 1 }, { i: 9, j: 1 }, { i: 10, j: 1 }, { i: 11, j: 1 },  ], css_id: 'tinytable_css_cranflko5gkmntr1e9id',}, 
          { positions: [ { i: 0, j: 1 },  ], css_id: 'tinytable_css_9r42nhdovpp3pfuvdg4l',}, 
          { positions: [ { i: 12, j: 0 },  ], css_id: 'tinytable_css_56ax728qdzsaymtr7ud3',}, 
          ];

          // Loop over the arrays to style the cells
          cellsToStyle.forEach(function (group) {
              group.positions.forEach(function (cell) {
                  styleCell_5t3ts6jjucs8t0pj075h(cell.i, cell.j, group.css_id);
              });
          });
      });
    </script>

    <style>
      /* tinytable css entries after */
      .table td.tinytable_css_zx3uq11l6ox1ydix9qwu, .table th.tinytable_css_zx3uq11l6ox1ydix9qwu { text-align: left; border-top: solid #d3d8dc 0.1em; border-bottom: solid #d3d8dc 0.05em; }
      .table td.tinytable_css_xj1wtis0fcvmkorwvgyt, .table th.tinytable_css_xj1wtis0fcvmkorwvgyt { text-align: center; border-bottom: solid black 0.05em; }
      .table td.tinytable_css_rd7zqmmncav25mujhvp9, .table th.tinytable_css_rd7zqmmncav25mujhvp9 { text-align: left; }
      .table td.tinytable_css_r9jar2ithqdu9cnp6zlh, .table th.tinytable_css_r9jar2ithqdu9cnp6zlh { text-align: center; border-bottom: solid #d3d8dc 0.1em; }
      .table td.tinytable_css_dum0cwpu1wxh10nuy02x, .table th.tinytable_css_dum0cwpu1wxh10nuy02x { text-align: left; border-bottom: solid black 0.05em; }
      .table td.tinytable_css_cranflko5gkmntr1e9id, .table th.tinytable_css_cranflko5gkmntr1e9id { text-align: center; }
      .table td.tinytable_css_9r42nhdovpp3pfuvdg4l, .table th.tinytable_css_9r42nhdovpp3pfuvdg4l { text-align: center; border-top: solid #d3d8dc 0.1em; border-bottom: solid #d3d8dc 0.05em; }
      .table td.tinytable_css_56ax728qdzsaymtr7ud3, .table th.tinytable_css_56ax728qdzsaymtr7ud3 { text-align: left; border-bottom: solid #d3d8dc 0.1em; }
    </style>
    <div class="container">
      <table class="table table-borderless" id="tinytable_5t3ts6jjucs8t0pj075h" style="width: auto; margin-left: auto; margin-right: auto;" data-quarto-disable-processing="true">
        <thead>
        
              <tr>
                <th scope="col"> </th>
                <th scope="col">(1)</th>
              </tr>
        </thead>
        
        <tbody>
                <tr>
                  <td>(Intercept)</td>
                  <td>5810.581</td>
                </tr>
                <tr>
                  <td></td>
                  <td>(528.246)</td>
                </tr>
                <tr>
                  <td>treat</td>
                  <td>538.563</td>
                </tr>
                <tr>
                  <td></td>
                  <td>(747.053)</td>
                </tr>
                <tr>
                  <td>Num.Obs.</td>
                  <td>370</td>
                </tr>
                <tr>
                  <td>R2</td>
                  <td>0.001</td>
                </tr>
                <tr>
                  <td>R2 Adj.</td>
                  <td>-0.001</td>
                </tr>
                <tr>
                  <td>AIC</td>
                  <td>7625.0</td>
                </tr>
                <tr>
                  <td>BIC</td>
                  <td>7636.8</td>
                </tr>
                <tr>
                  <td>Log.Lik.</td>
                  <td>-3809.508</td>
                </tr>
                <tr>
                  <td>F</td>
                  <td>0.520</td>
                </tr>
                <tr>
                  <td>RMSE</td>
                  <td>7165.48</td>
                </tr>
        </tbody>
      </table>
    </div>
<!-- hack to avoid NA insertion in last line -->
</div>
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1"></a><span class="fu">modelsummary</span>(<span class="fu">list</span>(<span class="st">"単回帰・非復元"</span> <span class="ot">=</span> mh_fit1), </span>
<span id="cb29-2"><a href="#cb29-2"></a>             <span class="at">estimate  =</span> <span class="st">"{estimate} ({std.error})"</span>,</span>
<span id="cb29-3"><a href="#cb29-3"></a>             <span class="at">statistic =</span> <span class="cn">NULL</span>,</span>
<span id="cb29-4"><a href="#cb29-4"></a>             <span class="at">gof_map   =</span> <span class="fu">c</span>(<span class="st">"nobs"</span>, <span class="st">"r.squared"</span>, <span class="st">"adj.r.squared"</span>))</span></code><button title="コピー" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<!-- preamble start -->

    <script>

      function styleCell_uo1ysby9hsiegspyn8kv(i, j, css_id) {
          var table = document.getElementById("tinytable_uo1ysby9hsiegspyn8kv");
          var cell = table.rows[i]?.cells[j];  // Safe navigation to avoid errors
          if (cell) {
              console.log(`Styling cell at (${i}, ${j}) with class ${css_id}`);
              cell.classList.add(css_id);
          } else {
              console.warn(`Cell at (${i}, ${j}) not found.`);
          }
      }
      function insertSpanRow(i, colspan, content) {
        var table = document.getElementById('tinytable_uo1ysby9hsiegspyn8kv');
        var newRow = table.insertRow(i);
        var newCell = newRow.insertCell(0);
        newCell.setAttribute("colspan", colspan);
        // newCell.innerText = content;
        // this may be unsafe, but innerText does not interpret <br>
        newCell.innerHTML = content;
      }
      function spanCell_uo1ysby9hsiegspyn8kv(i, j, rowspan, colspan) {
        var table = document.getElementById("tinytable_uo1ysby9hsiegspyn8kv");
        const targetRow = table.rows[i];
        const targetCell = targetRow.cells[j];
        for (let r = 0; r < rowspan; r++) {
          // Only start deleting cells to the right for the first row (r == 0)
          if (r === 0) {
            // Delete cells to the right of the target cell in the first row
            for (let c = colspan - 1; c > 0; c--) {
              if (table.rows[i + r].cells[j + c]) {
                table.rows[i + r].deleteCell(j + c);
              }
            }
          }
          // For rows below the first, delete starting from the target column
          if (r > 0) {
            for (let c = colspan - 1; c >= 0; c--) {
              if (table.rows[i + r] && table.rows[i + r].cells[j]) {
                table.rows[i + r].deleteCell(j);
              }
            }
          }
        }
        // Set rowspan and colspan of the target cell
        targetCell.rowSpan = rowspan;
        targetCell.colSpan = colspan;
      }
      // tinytable span after
      window.addEventListener('load', function () {
          var cellsToStyle = [
            // tinytable style arrays after
          { positions: [ { i: 1, j: 0 }, { i: 3, j: 0 }, { i: 4, j: 0 },  ], css_id: 'tinytable_css_v9jby7daj1t1thu3nqvb',}, 
          { positions: [ { i: 5, j: 1 },  ], css_id: 'tinytable_css_qz6yas059oua1nfvmn9a',}, 
          { positions: [ { i: 0, j: 0 },  ], css_id: 'tinytable_css_etzcshowtx5gn3ut194k',}, 
          { positions: [ { i: 2, j: 0 },  ], css_id: 'tinytable_css_bqd9f9rosem9g31n55yq',}, 
          { positions: [ { i: 1, j: 1 }, { i: 3, j: 1 }, { i: 4, j: 1 },  ], css_id: 'tinytable_css_baquvan38jceauwvo1f0',}, 
          { positions: [ { i: 0, j: 1 },  ], css_id: 'tinytable_css_b7fb6jlbemw7639h6app',}, 
          { positions: [ { i: 2, j: 1 },  ], css_id: 'tinytable_css_62xzj9mzuph7q6kkzjdl',}, 
          { positions: [ { i: 5, j: 0 },  ], css_id: 'tinytable_css_13kq23r5ciq2g632a4sx',}, 
          ];

          // Loop over the arrays to style the cells
          cellsToStyle.forEach(function (group) {
              group.positions.forEach(function (cell) {
                  styleCell_uo1ysby9hsiegspyn8kv(cell.i, cell.j, group.css_id);
              });
          });
      });
    </script>

    <style>
      /* tinytable css entries after */
      .table td.tinytable_css_v9jby7daj1t1thu3nqvb, .table th.tinytable_css_v9jby7daj1t1thu3nqvb { text-align: left; }
      .table td.tinytable_css_qz6yas059oua1nfvmn9a, .table th.tinytable_css_qz6yas059oua1nfvmn9a { text-align: center; border-bottom: solid #d3d8dc 0.1em; }
      .table td.tinytable_css_etzcshowtx5gn3ut194k, .table th.tinytable_css_etzcshowtx5gn3ut194k { text-align: left; border-top: solid #d3d8dc 0.1em; border-bottom: solid #d3d8dc 0.05em; }
      .table td.tinytable_css_bqd9f9rosem9g31n55yq, .table th.tinytable_css_bqd9f9rosem9g31n55yq { text-align: left; border-bottom: solid black 0.05em; }
      .table td.tinytable_css_baquvan38jceauwvo1f0, .table th.tinytable_css_baquvan38jceauwvo1f0 { text-align: center; }
      .table td.tinytable_css_b7fb6jlbemw7639h6app, .table th.tinytable_css_b7fb6jlbemw7639h6app { text-align: center; border-top: solid #d3d8dc 0.1em; border-bottom: solid #d3d8dc 0.05em; }
      .table td.tinytable_css_62xzj9mzuph7q6kkzjdl, .table th.tinytable_css_62xzj9mzuph7q6kkzjdl { text-align: center; border-bottom: solid black 0.05em; }
      .table td.tinytable_css_13kq23r5ciq2g632a4sx, .table th.tinytable_css_13kq23r5ciq2g632a4sx { text-align: left; border-bottom: solid #d3d8dc 0.1em; }
    </style>
    <div class="container">
      <table class="table table-borderless" id="tinytable_uo1ysby9hsiegspyn8kv" style="width: auto; margin-left: auto; margin-right: auto;" data-quarto-disable-processing="true">
        <thead>
        
              <tr>
                <th scope="col"> </th>
                <th scope="col">単回帰・非復元</th>
              </tr>
        </thead>
        
        <tbody>
                <tr>
                  <td>(Intercept)</td>
                  <td>5810.581 (528.246)</td>
                </tr>
                <tr>
                  <td>treat</td>
                  <td>538.563 (747.053)</td>
                </tr>
                <tr>
                  <td>Num.Obs.</td>
                  <td>370</td>
                </tr>
                <tr>
                  <td>R2</td>
                  <td>0.001</td>
                </tr>
                <tr>
                  <td>R2 Adj.</td>
                  <td>-0.001</td>
                </tr>
        </tbody>
      </table>
    </div>
<!-- hack to avoid NA insertion in last line -->
</div>
</div>
<p>　処置効果は約538.563ドルである。今回の結果は重回帰分析よりも推定値が低めであり、統計的に有意に職業訓練の効果があったとは言えないという結果が得られましたね。また、マッチング後のデータを使って<strong>重</strong>回帰分析を行うこともできる。マッチング後のデータを見ると、黒人ダミーのバランスは大幅に改善されたが、それでもまだアンバランスしていると言える。他にも、74・75年の所得や年齢もそれなりに標準化差分が大きい。このような場合、もう一度共変量を投入して分析を行うこともできる。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1"></a>mh_fit2 <span class="ot">&lt;-</span> <span class="fu">lm</span>(re78 <span class="sc">~</span> treat <span class="sc">+</span> age <span class="sc">+</span> educ <span class="sc">+</span> black <span class="sc">+</span> hispanic <span class="sc">+</span> married <span class="sc">+</span> </span>
<span id="cb30-2"><a href="#cb30-2"></a>                   nodegree <span class="sc">+</span> re74 <span class="sc">+</span> re75, <span class="at">data =</span> mh_data1)</span>
<span id="cb30-3"><a href="#cb30-3"></a></span>
<span id="cb30-4"><a href="#cb30-4"></a><span class="fu">modelsummary</span>(<span class="fu">list</span>(<span class="st">"単回帰・非復元"</span> <span class="ot">=</span> mh_fit1,</span>
<span id="cb30-5"><a href="#cb30-5"></a>                  <span class="st">"重回帰・非復元"</span> <span class="ot">=</span> mh_fit2), </span>
<span id="cb30-6"><a href="#cb30-6"></a>             <span class="at">gof_map   =</span> <span class="fu">c</span>(<span class="st">"nobs"</span>, <span class="st">"r.squared"</span>, <span class="st">"adj.r.squared"</span>))</span></code><button title="コピー" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<!-- preamble start -->

    <script>

      function styleCell_4ts8g4f39hdw00cruxsw(i, j, css_id) {
          var table = document.getElementById("tinytable_4ts8g4f39hdw00cruxsw");
          var cell = table.rows[i]?.cells[j];  // Safe navigation to avoid errors
          if (cell) {
              console.log(`Styling cell at (${i}, ${j}) with class ${css_id}`);
              cell.classList.add(css_id);
          } else {
              console.warn(`Cell at (${i}, ${j}) not found.`);
          }
      }
      function insertSpanRow(i, colspan, content) {
        var table = document.getElementById('tinytable_4ts8g4f39hdw00cruxsw');
        var newRow = table.insertRow(i);
        var newCell = newRow.insertCell(0);
        newCell.setAttribute("colspan", colspan);
        // newCell.innerText = content;
        // this may be unsafe, but innerText does not interpret <br>
        newCell.innerHTML = content;
      }
      function spanCell_4ts8g4f39hdw00cruxsw(i, j, rowspan, colspan) {
        var table = document.getElementById("tinytable_4ts8g4f39hdw00cruxsw");
        const targetRow = table.rows[i];
        const targetCell = targetRow.cells[j];
        for (let r = 0; r < rowspan; r++) {
          // Only start deleting cells to the right for the first row (r == 0)
          if (r === 0) {
            // Delete cells to the right of the target cell in the first row
            for (let c = colspan - 1; c > 0; c--) {
              if (table.rows[i + r].cells[j + c]) {
                table.rows[i + r].deleteCell(j + c);
              }
            }
          }
          // For rows below the first, delete starting from the target column
          if (r > 0) {
            for (let c = colspan - 1; c >= 0; c--) {
              if (table.rows[i + r] && table.rows[i + r].cells[j]) {
                table.rows[i + r].deleteCell(j);
              }
            }
          }
        }
        // Set rowspan and colspan of the target cell
        targetCell.rowSpan = rowspan;
        targetCell.colSpan = colspan;
      }
      // tinytable span after
      window.addEventListener('load', function () {
          var cellsToStyle = [
            // tinytable style arrays after
          { positions: [ { i: 0, j: 0 },  ], css_id: 'tinytable_css_w25j67fo4spsiwd32nvv',}, 
          { positions: [ { i: 1, j: 1 }, { i: 2, j: 1 }, { i: 4, j: 1 }, { i: 5, j: 1 }, { i: 6, j: 1 }, { i: 3, j: 1 }, { i: 8, j: 1 }, { i: 9, j: 1 }, { i: 10, j: 1 }, { i: 7, j: 1 }, { i: 12, j: 1 }, { i: 13, j: 1 }, { i: 14, j: 1 }, { i: 15, j: 1 }, { i: 16, j: 1 }, { i: 17, j: 1 }, { i: 18, j: 1 }, { i: 19, j: 1 }, { i: 9, j: 2 }, { i: 21, j: 1 }, { i: 22, j: 1 }, { i: 12, j: 2 }, { i: 11, j: 1 }, { i: 1, j: 2 }, { i: 2, j: 2 }, { i: 3, j: 2 }, { i: 4, j: 2 }, { i: 5, j: 2 }, { i: 6, j: 2 }, { i: 7, j: 2 }, { i: 8, j: 2 }, { i: 22, j: 2 }, { i: 10, j: 2 }, { i: 11, j: 2 }, { i: 16, j: 2 }, { i: 13, j: 2 }, { i: 14, j: 2 }, { i: 15, j: 2 }, { i: 17, j: 2 }, { i: 18, j: 2 }, { i: 19, j: 2 }, { i: 21, j: 2 },  ], css_id: 'tinytable_css_simr4w297ywzxwq4v615',}, 
          { positions: [ { i: 20, j: 2 }, { i: 20, j: 1 },  ], css_id: 'tinytable_css_pf0pi0ked9px77986blo',}, 
          { positions: [ { i: 23, j: 0 },  ], css_id: 'tinytable_css_kv8sst1ci5p9ixp0dxk1',}, 
          { positions: [ { i: 20, j: 0 },  ], css_id: 'tinytable_css_jrqngo05d13vzbj71n27',}, 
          { positions: [ { i: 23, j: 1 }, { i: 23, j: 2 },  ], css_id: 'tinytable_css_iqqk003hznrjk8e2fuqa',}, 
          { positions: [ { i: 0, j: 1 }, { i: 0, j: 2 },  ], css_id: 'tinytable_css_2965lrb3z1h8x08bskbp',}, 
          { positions: [ { i: 1, j: 0 }, { i: 2, j: 0 }, { i: 3, j: 0 }, { i: 4, j: 0 }, { i: 5, j: 0 }, { i: 6, j: 0 }, { i: 7, j: 0 }, { i: 8, j: 0 }, { i: 9, j: 0 }, { i: 10, j: 0 }, { i: 11, j: 0 }, { i: 12, j: 0 }, { i: 13, j: 0 }, { i: 14, j: 0 }, { i: 15, j: 0 }, { i: 16, j: 0 }, { i: 17, j: 0 }, { i: 18, j: 0 }, { i: 19, j: 0 }, { i: 21, j: 0 }, { i: 22, j: 0 },  ], css_id: 'tinytable_css_0epukg4el29owe4suhyb',}, 
          ];

          // Loop over the arrays to style the cells
          cellsToStyle.forEach(function (group) {
              group.positions.forEach(function (cell) {
                  styleCell_4ts8g4f39hdw00cruxsw(cell.i, cell.j, group.css_id);
              });
          });
      });
    </script>

    <style>
      /* tinytable css entries after */
      .table td.tinytable_css_w25j67fo4spsiwd32nvv, .table th.tinytable_css_w25j67fo4spsiwd32nvv { text-align: left; border-top: solid #d3d8dc 0.1em; border-bottom: solid #d3d8dc 0.05em; }
      .table td.tinytable_css_simr4w297ywzxwq4v615, .table th.tinytable_css_simr4w297ywzxwq4v615 { text-align: center; }
      .table td.tinytable_css_pf0pi0ked9px77986blo, .table th.tinytable_css_pf0pi0ked9px77986blo { text-align: center; border-bottom: solid black 0.05em; }
      .table td.tinytable_css_kv8sst1ci5p9ixp0dxk1, .table th.tinytable_css_kv8sst1ci5p9ixp0dxk1 { text-align: left; border-bottom: solid #d3d8dc 0.1em; }
      .table td.tinytable_css_jrqngo05d13vzbj71n27, .table th.tinytable_css_jrqngo05d13vzbj71n27 { text-align: left; border-bottom: solid black 0.05em; }
      .table td.tinytable_css_iqqk003hznrjk8e2fuqa, .table th.tinytable_css_iqqk003hznrjk8e2fuqa { text-align: center; border-bottom: solid #d3d8dc 0.1em; }
      .table td.tinytable_css_2965lrb3z1h8x08bskbp, .table th.tinytable_css_2965lrb3z1h8x08bskbp { text-align: center; border-top: solid #d3d8dc 0.1em; border-bottom: solid #d3d8dc 0.05em; }
      .table td.tinytable_css_0epukg4el29owe4suhyb, .table th.tinytable_css_0epukg4el29owe4suhyb { text-align: left; }
    </style>
    <div class="container">
      <table class="table table-borderless" id="tinytable_4ts8g4f39hdw00cruxsw" style="width: auto; margin-left: auto; margin-right: auto;" data-quarto-disable-processing="true">
        <thead>
        
              <tr>
                <th scope="col"> </th>
                <th scope="col">単回帰・非復元</th>
                <th scope="col">重回帰・非復元</th>
              </tr>
        </thead>
        
        <tbody>
                <tr>
                  <td>(Intercept)</td>
                  <td>5810.581</td>
                  <td>-563.793</td>
                </tr>
                <tr>
                  <td></td>
                  <td>(528.246)</td>
                  <td>(3546.733)</td>
                </tr>
                <tr>
                  <td>treat</td>
                  <td>538.563</td>
                  <td>1248.753</td>
                </tr>
                <tr>
                  <td></td>
                  <td>(747.053)</td>
                  <td>(812.200)</td>
                </tr>
                <tr>
                  <td>age</td>
                  <td></td>
                  <td>16.287</td>
                </tr>
                <tr>
                  <td></td>
                  <td></td>
                  <td>(45.729)</td>
                </tr>
                <tr>
                  <td>educ</td>
                  <td></td>
                  <td>536.770</td>
                </tr>
                <tr>
                  <td></td>
                  <td></td>
                  <td>(243.670)</td>
                </tr>
                <tr>
                  <td>black</td>
                  <td></td>
                  <td>-1122.952</td>
                </tr>
                <tr>
                  <td></td>
                  <td></td>
                  <td>(907.128)</td>
                </tr>
                <tr>
                  <td>hispanic</td>
                  <td></td>
                  <td>1162.968</td>
                </tr>
                <tr>
                  <td></td>
                  <td></td>
                  <td>(1677.286)</td>
                </tr>
                <tr>
                  <td>married</td>
                  <td></td>
                  <td>655.742</td>
                </tr>
                <tr>
                  <td></td>
                  <td></td>
                  <td>(984.969)</td>
                </tr>
                <tr>
                  <td>nodegree</td>
                  <td></td>
                  <td>-174.212</td>
                </tr>
                <tr>
                  <td></td>
                  <td></td>
                  <td>(1116.462)</td>
                </tr>
                <tr>
                  <td>re74</td>
                  <td></td>
                  <td>0.071</td>
                </tr>
                <tr>
                  <td></td>
                  <td></td>
                  <td>(0.098)</td>
                </tr>
                <tr>
                  <td>re75</td>
                  <td></td>
                  <td>0.273</td>
                </tr>
                <tr>
                  <td></td>
                  <td></td>
                  <td>(0.155)</td>
                </tr>
                <tr>
                  <td>Num.Obs.</td>
                  <td>370</td>
                  <td>370</td>
                </tr>
                <tr>
                  <td>R2</td>
                  <td>0.001</td>
                  <td>0.077</td>
                </tr>
                <tr>
                  <td>R2 Adj.</td>
                  <td>-0.001</td>
                  <td>0.054</td>
                </tr>
        </tbody>
      </table>
    </div>
<!-- hack to avoid NA insertion in last line -->
</div>
</div>
<p>　ちなみに、{MatchIt}パッケージを使った最近傍マッチングのの結果は行う度に変化することがある。{MatchIt}パッケージを使った最近傍マッチングの場合、処置群 (統制群)から一つのケースを選択し、最も近い統制群 (処置群)とマッチングする。マッチングされたケースは次のステップからはマッチング対象から除外されることになる<a href="#fn4" class="footnote-ref" id="fnref4" role="doc-noteref"><sup>4</sup></a>。また、1:1マッチングの場合<a href="#fn5" class="footnote-ref" id="fnref5" role="doc-noteref"><sup>5</sup></a>、同距離に複数のマッチング対象があると、ランダムに1つのみを選択する。最近傍マッチングを用いる際は、複数推定を行い、推定が安定するかを確認し、不安定な場合は他の手法を使うか、k-最近傍マッチングなどを使ってみよう。</p>
<p>　ここでは復元マッチングの例を紹介しよう。やり方は<code>matchit()</code>内に<code>replace = TRUE</code>を追加するだけだ。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1"></a>mh_mat2 <span class="ot">&lt;-</span> <span class="fu">matchit</span>(treat <span class="sc">~</span> age <span class="sc">+</span> educ <span class="sc">+</span> black <span class="sc">+</span> hispanic <span class="sc">+</span> married <span class="sc">+</span> </span>
<span id="cb31-2"><a href="#cb31-2"></a>                     nodegree <span class="sc">+</span> re74 <span class="sc">+</span> re75, </span>
<span id="cb31-3"><a href="#cb31-3"></a>                   <span class="at">data =</span> la_df, <span class="at">estimand =</span> <span class="st">"ATT"</span>, <span class="at">replace =</span> <span class="cn">TRUE</span>,</span>
<span id="cb31-4"><a href="#cb31-4"></a>                   <span class="at">method =</span> <span class="st">"nearest"</span>, <span class="at">distance =</span> <span class="st">"mahalanobis"</span>)</span>
<span id="cb31-5"><a href="#cb31-5"></a>mh_data2 <span class="ot">&lt;-</span> <span class="fu">match.data</span>(mh_mat2)</span></code><button title="コピー" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>　マッチング後のデータを確認する前に、バランスチェックをしてみよう。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1"></a><span class="fu">love.plot</span>(mh_mat2, <span class="at">thresholds =</span> <span class="fl">0.25</span>, <span class="at">abs =</span> <span class="cn">TRUE</span>)</span></code><button title="コピー" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="matching_files/figure-html/unnamed-chunk-25-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="1050"></p>
</figure>
</div>
</div>
</div>
<p>　復元マッチングのメリットは非復元マッチングに比べ、バランス改善の程度が大きいという点だ。非復元マッチングの場合、マッチングに使われた統制群は二度と使われないため、場合によっては近いマッチングケースがあるにも関わらず、マッチングできないからだ。ただし、復元マッチングにもデメリットはある。たとえば、有効サンプルサイズ（Effective Sample Size; ESS）が小さくなり、精度が悪くなる点、場合によっては特殊な標準誤差<a href="#fn6" class="footnote-ref" id="fnref6" role="doc-noteref"><sup>6</sup></a>を使う必要があるといった欠点もある。</p>
<p>　それではマッチング後のデータを確認してみよう。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1"></a>mh_data2</span></code><button title="コピー" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 263 × 12
   treat   age  educ black hispanic white married nodegree  re74  re75   re78
   &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;int&gt;    &lt;int&gt; &lt;int&gt;   &lt;int&gt;    &lt;int&gt; &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt;
 1     1    37    11     1        0     0       1        1     0     0  9930.
 2     1    22     9     0        1     0       0        1     0     0  3596.
 3     1    30    12     1        0     0       0        0     0     0 24909.
 4     1    27    11     1        0     0       0        1     0     0  7506.
 5     1    33     8     1        0     0       0        1     0     0   290.
 6     1    22     9     1        0     0       0        1     0     0  4056.
 7     1    23    12     1        0     0       0        0     0     0     0 
 8     1    32    11     1        0     0       0        1     0     0  8472.
 9     1    22    16     1        0     0       0        0     0     0  2164.
10     1    33    12     0        0     1       1        0     0     0 12418.
# ℹ 253 more rows
# ℹ 1 more variable: weights &lt;dbl&gt;</code></pre>
</div>
</div>
<p>　今回は370行ではないことが分かる。なぜなら統制群のケースが複数マッチングされることもあるからだ。処置群は100%使われるので、マッチングに使われた統制群のケースは260-185=75ケースである。この特徴により推定の際は一点、注意が必要である。推定のやり方自体はほぼ同じである。しかし、<strong>非</strong>復元マッチングの場合、統制群からマッチングされたケースは1回のみ使われるため、一つ一つのケースの重みは同じである。<code>match.data()</code>から得られーたデータには<code>weights</code>列が含まれており、<code>mh_data1</code>の<code>weights</code>列を見ると全ての重みが1だということが分かる。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1"></a>mh_data1<span class="sc">$</span>weights</span></code><button title="コピー" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  1   2   3   4   5   6   7   8   9  10  11  12  13  14  15  16  17  18  19  20 
  1   1   1   1   1   1   1   1   1   1   1   1   1   1   1   1   1   1   1   1 
 21  22  23  24  25  26  27  28  29  30  31  32  33  34  35  36  37  38  39  40 
  1   1   1   1   1   1   1   1   1   1   1   1   1   1   1   1   1   1   1   1 
 41  42  43  44  45  46  47  48  49  50  51  52  53  54  55  56  57  58  59  60 
  1   1   1   1   1   1   1   1   1   1   1   1   1   1   1   1   1   1   1   1 
 61  62  63  64  65  66  67  68  69  70  71  72  73  74  75  76  77  78  79  80 
  1   1   1   1   1   1   1   1   1   1   1   1   1   1   1   1   1   1   1   1 
 81  82  83  84  85  86  87  88  89  90  91  92  93  94  95  96  97  98  99 100 
  1   1   1   1   1   1   1   1   1   1   1   1   1   1   1   1   1   1   1   1 
101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 
  1   1   1   1   1   1   1   1   1   1   1   1   1   1   1   1   1   1   1   1 
121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 
  1   1   1   1   1   1   1   1   1   1   1   1   1   1   1   1   1   1   1   1 
141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 160 
  1   1   1   1   1   1   1   1   1   1   1   1   1   1   1   1   1   1   1   1 
161 162 163 164 165 166 167 168 169 170 171 172 173 174 175 176 177 178 179 180 
  1   1   1   1   1   1   1   1   1   1   1   1   1   1   1   1   1   1   1   1 
181 182 183 184 185 186 190 191 192 193 195 200 202 203 205 208 209 212 226 228 
  1   1   1   1   1   1   1   1   1   1   1   1   1   1   1   1   1   1   1   1 
231 233 244 254 257 271 273 274 275 276 278 279 280 281 282 283 284 285 288 290 
  1   1   1   1   1   1   1   1   1   1   1   1   1   1   1   1   1   1   1   1 
295 296 297 303 306 312 319 322 323 325 327 335 339 342 343 344 352 353 356 358 
  1   1   1   1   1   1   1   1   1   1   1   1   1   1   1   1   1   1   1   1 
362 363 364 365 367 368 369 370 372 374 376 378 381 384 387 390 393 394 398 399 
  1   1   1   1   1   1   1   1   1   1   1   1   1   1   1   1   1   1   1   1 
402 403 405 409 411 413 414 415 416 419 420 422 423 427 430 432 436 438 441 443 
  1   1   1   1   1   1   1   1   1   1   1   1   1   1   1   1   1   1   1   1 
445 446 450 451 453 454 455 457 458 459 462 463 465 466 467 470 474 475 476 478 
  1   1   1   1   1   1   1   1   1   1   1   1   1   1   1   1   1   1   1   1 
485 493 499 500 501 507 508 510 511 512 515 516 518 520 522 524 525 526 527 530 
  1   1   1   1   1   1   1   1   1   1   1   1   1   1   1   1   1   1   1   1 
536 537 538 539 540 541 542 544 546 551 552 553 555 556 557 558 559 560 561 562 
  1   1   1   1   1   1   1   1   1   1   1   1   1   1   1   1   1   1   1   1 
563 565 566 567 571 572 573 574 576 577 578 580 581 582 583 584 585 586 591 592 
  1   1   1   1   1   1   1   1   1   1   1   1   1   1   1   1   1   1   1   1 
593 594 596 597 601 604 608 610 613 614 
  1   1   1   1   1   1   1   1   1   1 </code></pre>
</div>
</div>
<p>　一方、復元マッチングの場合、一つのケースが複数回マッチングされる場合もある。たとえば、191番目のケースは統制群であるが、重みが1.2162162だ。この意味は191番目のケースは計3回（<span class="math inline">\(1.2162162\times\frac{185}{75}\)</span>）マッチングに使われたことを意味する。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1"></a>mh_data2<span class="sc">$</span>weights</span></code><button title="コピー" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>        1         2         3         4         5         6         7         8 
1.0000000 1.0000000 1.0000000 1.0000000 1.0000000 1.0000000 1.0000000 1.0000000 
        9        10        11        12        13        14        15        16 
1.0000000 1.0000000 1.0000000 1.0000000 1.0000000 1.0000000 1.0000000 1.0000000 
       17        18        19        20        21        22        23        24 
1.0000000 1.0000000 1.0000000 1.0000000 1.0000000 1.0000000 1.0000000 1.0000000 
       25        26        27        28        29        30        31        32 
1.0000000 1.0000000 1.0000000 1.0000000 1.0000000 1.0000000 1.0000000 1.0000000 
       33        34        35        36        37        38        39        40 
1.0000000 1.0000000 1.0000000 1.0000000 1.0000000 1.0000000 1.0000000 1.0000000 
       41        42        43        44        45        46        47        48 
1.0000000 1.0000000 1.0000000 1.0000000 1.0000000 1.0000000 1.0000000 1.0000000 
       49        50        51        52        53        54        55        56 
1.0000000 1.0000000 1.0000000 1.0000000 1.0000000 1.0000000 1.0000000 1.0000000 
       57        58        59        60        61        62        63        64 
1.0000000 1.0000000 1.0000000 1.0000000 1.0000000 1.0000000 1.0000000 1.0000000 
       65        66        67        68        69        70        71        72 
1.0000000 1.0000000 1.0000000 1.0000000 1.0000000 1.0000000 1.0000000 1.0000000 
       73        74        75        76        77        78        79        80 
1.0000000 1.0000000 1.0000000 1.0000000 1.0000000 1.0000000 1.0000000 1.0000000 
       81        82        83        84        85        86        87        88 
1.0000000 1.0000000 1.0000000 1.0000000 1.0000000 1.0000000 1.0000000 1.0000000 
       89        90        91        92        93        94        95        96 
1.0000000 1.0000000 1.0000000 1.0000000 1.0000000 1.0000000 1.0000000 1.0000000 
       97        98        99       100       101       102       103       104 
1.0000000 1.0000000 1.0000000 1.0000000 1.0000000 1.0000000 1.0000000 1.0000000 
      105       106       107       108       109       110       111       112 
1.0000000 1.0000000 1.0000000 1.0000000 1.0000000 1.0000000 1.0000000 1.0000000 
      113       114       115       116       117       118       119       120 
1.0000000 1.0000000 1.0000000 1.0000000 1.0000000 1.0000000 1.0000000 1.0000000 
      121       122       123       124       125       126       127       128 
1.0000000 1.0000000 1.0000000 1.0000000 1.0000000 1.0000000 1.0000000 1.0000000 
      129       130       131       132       133       134       135       136 
1.0000000 1.0000000 1.0000000 1.0000000 1.0000000 1.0000000 1.0000000 1.0000000 
      137       138       139       140       141       142       143       144 
1.0000000 1.0000000 1.0000000 1.0000000 1.0000000 1.0000000 1.0000000 1.0000000 
      145       146       147       148       149       150       151       152 
1.0000000 1.0000000 1.0000000 1.0000000 1.0000000 1.0000000 1.0000000 1.0000000 
      153       154       155       156       157       158       159       160 
1.0000000 1.0000000 1.0000000 1.0000000 1.0000000 1.0000000 1.0000000 1.0000000 
      161       162       163       164       165       166       167       168 
1.0000000 1.0000000 1.0000000 1.0000000 1.0000000 1.0000000 1.0000000 1.0000000 
      169       170       171       172       173       174       175       176 
1.0000000 1.0000000 1.0000000 1.0000000 1.0000000 1.0000000 1.0000000 1.0000000 
      177       178       179       180       181       182       183       184 
1.0000000 1.0000000 1.0000000 1.0000000 1.0000000 1.0000000 1.0000000 1.0000000 
      185       191       202       244       257       280       281       282 
1.0000000 1.2648649 0.4216216 0.4216216 0.4216216 0.4216216 0.4216216 0.4216216 
      284       295       297       303       312       319       325       335 
1.6864865 0.8432432 0.4216216 3.7945946 0.4216216 1.6864865 2.5297297 0.4216216 
      343       344       353       362       364       384       387       403 
0.4216216 0.8432432 0.4216216 0.4216216 0.8432432 0.4216216 0.4216216 0.8432432 
      405       409       411       413       420       422       423       432 
0.4216216 0.4216216 2.1081081 0.8432432 0.4216216 0.4216216 0.4216216 0.4216216 
      438       450       451       454       463       475       476       493 
1.6864865 0.4216216 0.8432432 1.2648649 0.4216216 0.4216216 0.4216216 1.2648649 
      507       511       512       515       516       518       520       524 
0.4216216 0.4216216 0.4216216 0.4216216 0.8432432 0.8432432 0.8432432 0.4216216 
      526       530       537       538       539       540       546       551 
0.4216216 0.4216216 3.3729730 0.8432432 0.4216216 0.8432432 0.4216216 0.4216216 
      552       553       557       558       561       565       566       571 
1.2648649 5.4810811 0.8432432 1.6864865 0.4216216 0.4216216 0.4216216 1.2648649 
      573       574       576       578       583       584       585       586 
2.5297297 1.2648649 0.4216216 0.4216216 1.2648649 1.2648649 1.2648649 1.6864865 
      592       596       597       601       604       608       613 
0.8432432 0.4216216 0.8432432 1.2648649 0.4216216 7.5891892 0.4216216 </code></pre>
</div>
</div>
<p>　したがって、復元マッチングの場合、<code>lm()</code>内に<code>weights</code>引数を必ず指定する必要がある。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1"></a>mh_fit3 <span class="ot">&lt;-</span> <span class="fu">lm</span>(re78 <span class="sc">~</span> treat, </span>
<span id="cb39-2"><a href="#cb39-2"></a>              <span class="at">data =</span> mh_data2, <span class="at">weights =</span> weights)</span>
<span id="cb39-3"><a href="#cb39-3"></a>mh_fit4 <span class="ot">&lt;-</span> <span class="fu">lm</span>(re78 <span class="sc">~</span> treat <span class="sc">+</span> age <span class="sc">+</span> educ <span class="sc">+</span> black <span class="sc">+</span> hispanic <span class="sc">+</span> married <span class="sc">+</span> </span>
<span id="cb39-4"><a href="#cb39-4"></a>                   nodegree <span class="sc">+</span> re74 <span class="sc">+</span> re75, </span>
<span id="cb39-5"><a href="#cb39-5"></a>              <span class="at">data =</span> mh_data2, <span class="at">weights =</span> weights)</span>
<span id="cb39-6"><a href="#cb39-6"></a></span>
<span id="cb39-7"><a href="#cb39-7"></a><span class="fu">modelsummary</span>(<span class="fu">list</span>(<span class="st">"単回帰・非復元"</span> <span class="ot">=</span> mh_fit1,</span>
<span id="cb39-8"><a href="#cb39-8"></a>                  <span class="st">"重回帰・非復元"</span> <span class="ot">=</span> mh_fit2,</span>
<span id="cb39-9"><a href="#cb39-9"></a>                  <span class="st">"単回帰・復元"</span>   <span class="ot">=</span> mh_fit3,</span>
<span id="cb39-10"><a href="#cb39-10"></a>                  <span class="st">"重回帰・復元"</span>   <span class="ot">=</span> mh_fit4), </span>
<span id="cb39-11"><a href="#cb39-11"></a>             <span class="at">gof_map   =</span> <span class="fu">c</span>(<span class="st">"nobs"</span>, <span class="st">"r.squared"</span>, <span class="st">"adj.r.squared"</span>))</span></code><button title="コピー" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<!-- preamble start -->

    <script>

      function styleCell_co7wsvrrn19q70haj8lx(i, j, css_id) {
          var table = document.getElementById("tinytable_co7wsvrrn19q70haj8lx");
          var cell = table.rows[i]?.cells[j];  // Safe navigation to avoid errors
          if (cell) {
              console.log(`Styling cell at (${i}, ${j}) with class ${css_id}`);
              cell.classList.add(css_id);
          } else {
              console.warn(`Cell at (${i}, ${j}) not found.`);
          }
      }
      function insertSpanRow(i, colspan, content) {
        var table = document.getElementById('tinytable_co7wsvrrn19q70haj8lx');
        var newRow = table.insertRow(i);
        var newCell = newRow.insertCell(0);
        newCell.setAttribute("colspan", colspan);
        // newCell.innerText = content;
        // this may be unsafe, but innerText does not interpret <br>
        newCell.innerHTML = content;
      }
      function spanCell_co7wsvrrn19q70haj8lx(i, j, rowspan, colspan) {
        var table = document.getElementById("tinytable_co7wsvrrn19q70haj8lx");
        const targetRow = table.rows[i];
        const targetCell = targetRow.cells[j];
        for (let r = 0; r < rowspan; r++) {
          // Only start deleting cells to the right for the first row (r == 0)
          if (r === 0) {
            // Delete cells to the right of the target cell in the first row
            for (let c = colspan - 1; c > 0; c--) {
              if (table.rows[i + r].cells[j + c]) {
                table.rows[i + r].deleteCell(j + c);
              }
            }
          }
          // For rows below the first, delete starting from the target column
          if (r > 0) {
            for (let c = colspan - 1; c >= 0; c--) {
              if (table.rows[i + r] && table.rows[i + r].cells[j]) {
                table.rows[i + r].deleteCell(j);
              }
            }
          }
        }
        // Set rowspan and colspan of the target cell
        targetCell.rowSpan = rowspan;
        targetCell.colSpan = colspan;
      }
      // tinytable span after
      window.addEventListener('load', function () {
          var cellsToStyle = [
            // tinytable style arrays after
          { positions: [ { i: 0, j: 1 }, { i: 0, j: 4 }, { i: 0, j: 2 }, { i: 0, j: 3 },  ], css_id: 'tinytable_css_t4vxe46qevvi6rv9wodw',}, 
          { positions: [ { i: 0, j: 0 },  ], css_id: 'tinytable_css_ouon4yezzy6h5x11wtdn',}, 
          { positions: [ { i: 20, j: 0 },  ], css_id: 'tinytable_css_lqso0mextppk8lyz4hs8',}, 
          { positions: [ { i: 1, j: 1 }, { i: 5, j: 1 }, { i: 2, j: 1 }, { i: 3, j: 1 }, { i: 4, j: 1 }, { i: 9, j: 1 }, { i: 10, j: 1 }, { i: 7, j: 1 }, { i: 12, j: 1 }, { i: 13, j: 1 }, { i: 14, j: 1 }, { i: 15, j: 1 }, { i: 16, j: 1 }, { i: 17, j: 1 }, { i: 18, j: 1 }, { i: 6, j: 1 }, { i: 12, j: 3 }, { i: 21, j: 1 }, { i: 22, j: 1 }, { i: 15, j: 3 }, { i: 11, j: 1 }, { i: 1, j: 2 }, { i: 2, j: 2 }, { i: 3, j: 2 }, { i: 4, j: 2 }, { i: 5, j: 2 }, { i: 6, j: 2 }, { i: 7, j: 2 }, { i: 19, j: 1 }, { i: 9, j: 2 }, { i: 10, j: 2 }, { i: 11, j: 2 }, { i: 12, j: 2 }, { i: 13, j: 2 }, { i: 14, j: 2 }, { i: 15, j: 2 }, { i: 16, j: 2 }, { i: 17, j: 2 }, { i: 18, j: 2 }, { i: 19, j: 2 }, { i: 12, j: 4 }, { i: 21, j: 2 }, { i: 22, j: 2 }, { i: 15, j: 4 }, { i: 8, j: 1 }, { i: 1, j: 3 }, { i: 2, j: 3 }, { i: 3, j: 3 }, { i: 4, j: 3 }, { i: 5, j: 3 }, { i: 6, j: 3 }, { i: 7, j: 3 }, { i: 8, j: 3 }, { i: 9, j: 3 }, { i: 10, j: 3 }, { i: 11, j: 3 }, { i: 1, j: 4 }, { i: 13, j: 3 }, { i: 14, j: 3 }, { i: 4, j: 4 }, { i: 16, j: 3 }, { i: 17, j: 3 }, { i: 18, j: 3 }, { i: 19, j: 3 }, { i: 9, j: 4 }, { i: 21, j: 3 }, { i: 22, j: 3 }, { i: 3, j: 4 }, { i: 8, j: 2 }, { i: 14, j: 4 }, { i: 2, j: 4 }, { i: 7, j: 4 }, { i: 17, j: 4 }, { i: 5, j: 4 }, { i: 6, j: 4 }, { i: 11, j: 4 }, { i: 8, j: 4 }, { i: 22, j: 4 }, { i: 10, j: 4 }, { i: 19, j: 4 }, { i: 16, j: 4 }, { i: 13, j: 4 }, { i: 18, j: 4 }, { i: 21, j: 4 },  ], css_id: 'tinytable_css_hcelu2ne95yyrf9eutlp',}, 
          { positions: [ { i: 1, j: 0 }, { i: 2, j: 0 }, { i: 3, j: 0 }, { i: 4, j: 0 }, { i: 5, j: 0 }, { i: 6, j: 0 }, { i: 7, j: 0 }, { i: 8, j: 0 }, { i: 9, j: 0 }, { i: 10, j: 0 }, { i: 11, j: 0 }, { i: 12, j: 0 }, { i: 13, j: 0 }, { i: 14, j: 0 }, { i: 15, j: 0 }, { i: 16, j: 0 }, { i: 17, j: 0 }, { i: 18, j: 0 }, { i: 19, j: 0 }, { i: 21, j: 0 }, { i: 22, j: 0 },  ], css_id: 'tinytable_css_dg29noc82tdx3ukgcu7u',}, 
          { positions: [ { i: 23, j: 0 },  ], css_id: 'tinytable_css_8rirygz5bapcqktr1xu2',}, 
          { positions: [ { i: 20, j: 2 }, { i: 20, j: 4 }, { i: 20, j: 1 }, { i: 20, j: 3 },  ], css_id: 'tinytable_css_7knsy8omxoent2cyvi7u',}, 
          { positions: [ { i: 23, j: 2 }, { i: 23, j: 3 }, { i: 23, j: 1 }, { i: 23, j: 4 },  ], css_id: 'tinytable_css_22a1tnh4vkv736sdem0j',}, 
          ];

          // Loop over the arrays to style the cells
          cellsToStyle.forEach(function (group) {
              group.positions.forEach(function (cell) {
                  styleCell_co7wsvrrn19q70haj8lx(cell.i, cell.j, group.css_id);
              });
          });
      });
    </script>

    <style>
      /* tinytable css entries after */
      .table td.tinytable_css_t4vxe46qevvi6rv9wodw, .table th.tinytable_css_t4vxe46qevvi6rv9wodw { text-align: center; border-top: solid #d3d8dc 0.1em; border-bottom: solid #d3d8dc 0.05em; }
      .table td.tinytable_css_ouon4yezzy6h5x11wtdn, .table th.tinytable_css_ouon4yezzy6h5x11wtdn { text-align: left; border-top: solid #d3d8dc 0.1em; border-bottom: solid #d3d8dc 0.05em; }
      .table td.tinytable_css_lqso0mextppk8lyz4hs8, .table th.tinytable_css_lqso0mextppk8lyz4hs8 { text-align: left; border-bottom: solid black 0.05em; }
      .table td.tinytable_css_hcelu2ne95yyrf9eutlp, .table th.tinytable_css_hcelu2ne95yyrf9eutlp { text-align: center; }
      .table td.tinytable_css_dg29noc82tdx3ukgcu7u, .table th.tinytable_css_dg29noc82tdx3ukgcu7u { text-align: left; }
      .table td.tinytable_css_8rirygz5bapcqktr1xu2, .table th.tinytable_css_8rirygz5bapcqktr1xu2 { text-align: left; border-bottom: solid #d3d8dc 0.1em; }
      .table td.tinytable_css_7knsy8omxoent2cyvi7u, .table th.tinytable_css_7knsy8omxoent2cyvi7u { text-align: center; border-bottom: solid black 0.05em; }
      .table td.tinytable_css_22a1tnh4vkv736sdem0j, .table th.tinytable_css_22a1tnh4vkv736sdem0j { text-align: center; border-bottom: solid #d3d8dc 0.1em; }
    </style>
    <div class="container">
      <table class="table table-borderless" id="tinytable_co7wsvrrn19q70haj8lx" style="width: auto; margin-left: auto; margin-right: auto;" data-quarto-disable-processing="true">
        <thead>
        
              <tr>
                <th scope="col"> </th>
                <th scope="col">単回帰・非復元</th>
                <th scope="col">重回帰・非復元</th>
                <th scope="col">単回帰・復元</th>
                <th scope="col">重回帰・復元</th>
              </tr>
        </thead>
        
        <tbody>
                <tr>
                  <td>(Intercept)</td>
                  <td>5810.581</td>
                  <td>-563.793</td>
                  <td>5953.896</td>
                  <td>1367.609</td>
                </tr>
                <tr>
                  <td></td>
                  <td>(528.246)</td>
                  <td>(3546.733)</td>
                  <td>(832.765)</td>
                  <td>(4742.325)</td>
                </tr>
                <tr>
                  <td>treat</td>
                  <td>538.563</td>
                  <td>1248.753</td>
                  <td>395.247</td>
                  <td>319.158</td>
                </tr>
                <tr>
                  <td></td>
                  <td>(747.053)</td>
                  <td>(812.200)</td>
                  <td>(992.921)</td>
                  <td>(989.821)</td>
                </tr>
                <tr>
                  <td>age</td>
                  <td></td>
                  <td>16.287</td>
                  <td></td>
                  <td>0.738</td>
                </tr>
                <tr>
                  <td></td>
                  <td></td>
                  <td>(45.729)</td>
                  <td></td>
                  <td>(63.289)</td>
                </tr>
                <tr>
                  <td>educ</td>
                  <td></td>
                  <td>536.770</td>
                  <td></td>
                  <td>513.097</td>
                </tr>
                <tr>
                  <td></td>
                  <td></td>
                  <td>(243.670)</td>
                  <td></td>
                  <td>(315.294)</td>
                </tr>
                <tr>
                  <td>black</td>
                  <td></td>
                  <td>-1122.952</td>
                  <td></td>
                  <td>-1441.462</td>
                </tr>
                <tr>
                  <td></td>
                  <td></td>
                  <td>(907.128)</td>
                  <td></td>
                  <td>(1547.443)</td>
                </tr>
                <tr>
                  <td>hispanic</td>
                  <td></td>
                  <td>1162.968</td>
                  <td></td>
                  <td>47.198</td>
                </tr>
                <tr>
                  <td></td>
                  <td></td>
                  <td>(1677.286)</td>
                  <td></td>
                  <td>(2391.301)</td>
                </tr>
                <tr>
                  <td>married</td>
                  <td></td>
                  <td>655.742</td>
                  <td></td>
                  <td>294.628</td>
                </tr>
                <tr>
                  <td></td>
                  <td></td>
                  <td>(984.969)</td>
                  <td></td>
                  <td>(1268.718)</td>
                </tr>
                <tr>
                  <td>nodegree</td>
                  <td></td>
                  <td>-174.212</td>
                  <td></td>
                  <td>17.309</td>
                </tr>
                <tr>
                  <td></td>
                  <td></td>
                  <td>(1116.462)</td>
                  <td></td>
                  <td>(1401.818)</td>
                </tr>
                <tr>
                  <td>re74</td>
                  <td></td>
                  <td>0.071</td>
                  <td></td>
                  <td>0.082</td>
                </tr>
                <tr>
                  <td></td>
                  <td></td>
                  <td>(0.098)</td>
                  <td></td>
                  <td>(0.132)</td>
                </tr>
                <tr>
                  <td>re75</td>
                  <td></td>
                  <td>0.273</td>
                  <td></td>
                  <td>0.200</td>
                </tr>
                <tr>
                  <td></td>
                  <td></td>
                  <td>(0.155)</td>
                  <td></td>
                  <td>(0.205)</td>
                </tr>
                <tr>
                  <td>Num.Obs.</td>
                  <td>370</td>
                  <td>370</td>
                  <td>263</td>
                  <td>263</td>
                </tr>
                <tr>
                  <td>R2</td>
                  <td>0.001</td>
                  <td>0.077</td>
                  <td>0.001</td>
                  <td>0.043</td>
                </tr>
                <tr>
                  <td>R2 Adj.</td>
                  <td>-0.001</td>
                  <td>0.054</td>
                  <td>-0.003</td>
                  <td>0.009</td>
                </tr>
        </tbody>
      </table>
    </div>
<!-- hack to avoid NA insertion in last line -->
</div>
</div>
<p>　推定の結果は、いずれも正であり、職業訓練は所得に正の影響を与えるという結果が得られている。しかし、いずれも標準誤差が非常に大きく、統計的に有意な結果は得られていない。</p>
</section>
<section id="傾向スコア" class="level3">
<h3 class="anchored" data-anchor-id="傾向スコア">傾向スコア</h3>
<p>　傾向スコアマッチングも、これまでのコードとほぼ同じだ。マハラノビス最近傍マッチングのコマンドから<code>distance = ...</code>引数を抜けば、傾向スコアマッチングができる<a href="#fn7" class="footnote-ref" id="fnref7" role="doc-noteref"><sup>7</sup></a>。ここでも<code>replace = TRUE</code>を指定し、復元マッチングをやってみよう。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1"></a>ps_mat <span class="ot">&lt;-</span> <span class="fu">matchit</span>(treat <span class="sc">~</span> age <span class="sc">+</span> educ <span class="sc">+</span> black <span class="sc">+</span> hispanic <span class="sc">+</span> married <span class="sc">+</span> </span>
<span id="cb40-2"><a href="#cb40-2"></a>                    nodegree <span class="sc">+</span> re74 <span class="sc">+</span> re75, </span>
<span id="cb40-3"><a href="#cb40-3"></a>                  <span class="at">data =</span> la_df, <span class="at">replace =</span> <span class="cn">TRUE</span>,</span>
<span id="cb40-4"><a href="#cb40-4"></a>                  <span class="at">method =</span> <span class="st">"nearest"</span>, <span class="at">estimand =</span> <span class="st">"ATT"</span>)</span></code><button title="コピー" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>　続いて、バランスチェックをしよう。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1"></a><span class="fu">love.plot</span>(ps_mat, <span class="at">thresholds =</span> <span class="fl">0.25</span>, <span class="at">abs =</span> <span class="cn">TRUE</span>)</span></code><button title="コピー" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="matching_files/figure-html/unnamed-chunk-31-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="1050"></p>
</figure>
</div>
</div>
</div>
<p>　バランスが大幅に改善されていることが分かる。ちなみに最上段の<code>distance</code>は傾向スコアを意味する。</p>
<p>　それでは、ATT推定のためにマッチング後のデータを抽出しよう。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1"></a><span class="co"># 傾向スコアマッチング後のデータセットを抽出</span></span>
<span id="cb42-2"><a href="#cb42-2"></a>ps_data <span class="ot">&lt;-</span> <span class="fu">match.data</span>(ps_mat)</span></code><button title="コピー" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>　傾向スコアを用いたATTをの推定もこれまでと同様、回帰分析を使用する。ここでも共変量なしの単回帰とありの重回帰を行い、マハラノビス距離最近傍マッチング（復元）と結果を比べてみよう。。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1"></a><span class="co"># 処置効果の推定</span></span>
<span id="cb43-2"><a href="#cb43-2"></a>ps_fit1 <span class="ot">&lt;-</span> <span class="fu">lm</span>(re78 <span class="sc">~</span> treat, </span>
<span id="cb43-3"><a href="#cb43-3"></a>             <span class="at">data =</span> ps_data, <span class="at">weights =</span> weights)</span>
<span id="cb43-4"><a href="#cb43-4"></a>ps_fit2 <span class="ot">&lt;-</span> <span class="fu">lm</span>(re78 <span class="sc">~</span> treat <span class="sc">+</span> age <span class="sc">+</span> educ <span class="sc">+</span> black <span class="sc">+</span> hispanic <span class="sc">+</span> </span>
<span id="cb43-5"><a href="#cb43-5"></a>                married <span class="sc">+</span> nodegree <span class="sc">+</span> re74 <span class="sc">+</span> re75, </span>
<span id="cb43-6"><a href="#cb43-6"></a>             <span class="at">data =</span> ps_data, <span class="at">weights =</span> weights)</span>
<span id="cb43-7"><a href="#cb43-7"></a></span>
<span id="cb43-8"><a href="#cb43-8"></a><span class="fu">modelsummary</span>(<span class="fu">list</span>(<span class="st">"MH (単回帰)"</span>   <span class="ot">=</span> mh_fit3,</span>
<span id="cb43-9"><a href="#cb43-9"></a>                  <span class="st">"MH (重回帰)"</span>   <span class="ot">=</span> mh_fit4,</span>
<span id="cb43-10"><a href="#cb43-10"></a>                  <span class="st">"PS (単回帰)"</span>   <span class="ot">=</span> ps_fit1,</span>
<span id="cb43-11"><a href="#cb43-11"></a>                  <span class="st">"PS (重回帰)"</span>   <span class="ot">=</span> ps_fit2), </span>
<span id="cb43-12"><a href="#cb43-12"></a>             <span class="at">gof_map   =</span> <span class="fu">c</span>(<span class="st">"nobs"</span>, <span class="st">"r.squared"</span>, <span class="st">"adj.r.squared"</span>))</span></code><button title="コピー" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<!-- preamble start -->

    <script>

      function styleCell_hpxwle723b9tjj7db5ip(i, j, css_id) {
          var table = document.getElementById("tinytable_hpxwle723b9tjj7db5ip");
          var cell = table.rows[i]?.cells[j];  // Safe navigation to avoid errors
          if (cell) {
              console.log(`Styling cell at (${i}, ${j}) with class ${css_id}`);
              cell.classList.add(css_id);
          } else {
              console.warn(`Cell at (${i}, ${j}) not found.`);
          }
      }
      function insertSpanRow(i, colspan, content) {
        var table = document.getElementById('tinytable_hpxwle723b9tjj7db5ip');
        var newRow = table.insertRow(i);
        var newCell = newRow.insertCell(0);
        newCell.setAttribute("colspan", colspan);
        // newCell.innerText = content;
        // this may be unsafe, but innerText does not interpret <br>
        newCell.innerHTML = content;
      }
      function spanCell_hpxwle723b9tjj7db5ip(i, j, rowspan, colspan) {
        var table = document.getElementById("tinytable_hpxwle723b9tjj7db5ip");
        const targetRow = table.rows[i];
        const targetCell = targetRow.cells[j];
        for (let r = 0; r < rowspan; r++) {
          // Only start deleting cells to the right for the first row (r == 0)
          if (r === 0) {
            // Delete cells to the right of the target cell in the first row
            for (let c = colspan - 1; c > 0; c--) {
              if (table.rows[i + r].cells[j + c]) {
                table.rows[i + r].deleteCell(j + c);
              }
            }
          }
          // For rows below the first, delete starting from the target column
          if (r > 0) {
            for (let c = colspan - 1; c >= 0; c--) {
              if (table.rows[i + r] && table.rows[i + r].cells[j]) {
                table.rows[i + r].deleteCell(j);
              }
            }
          }
        }
        // Set rowspan and colspan of the target cell
        targetCell.rowSpan = rowspan;
        targetCell.colSpan = colspan;
      }
      // tinytable span after
      window.addEventListener('load', function () {
          var cellsToStyle = [
            // tinytable style arrays after
          { positions: [ { i: 20, j: 0 },  ], css_id: 'tinytable_css_wqjmlofecvwgjgrsqrp0',}, 
          { positions: [ { i: 20, j: 2 }, { i: 20, j: 4 }, { i: 20, j: 1 }, { i: 20, j: 3 },  ], css_id: 'tinytable_css_rnyu0f1x5olh9b2rzgbq',}, 
          { positions: [ { i: 1, j: 0 }, { i: 2, j: 0 }, { i: 3, j: 0 }, { i: 4, j: 0 }, { i: 5, j: 0 }, { i: 6, j: 0 }, { i: 7, j: 0 }, { i: 8, j: 0 }, { i: 9, j: 0 }, { i: 10, j: 0 }, { i: 11, j: 0 }, { i: 12, j: 0 }, { i: 13, j: 0 }, { i: 14, j: 0 }, { i: 15, j: 0 }, { i: 16, j: 0 }, { i: 17, j: 0 }, { i: 18, j: 0 }, { i: 19, j: 0 }, { i: 21, j: 0 }, { i: 22, j: 0 },  ], css_id: 'tinytable_css_qud0t3dow26d75cy6lqf',}, 
          { positions: [ { i: 23, j: 0 },  ], css_id: 'tinytable_css_orbjpn3xc26nh1et9dit',}, 
          { positions: [ { i: 23, j: 2 }, { i: 23, j: 3 }, { i: 23, j: 1 }, { i: 23, j: 4 },  ], css_id: 'tinytable_css_hhl4syhq4pmcmnnmbiu0',}, 
          { positions: [ { i: 1, j: 1 }, { i: 5, j: 1 }, { i: 2, j: 1 }, { i: 3, j: 1 }, { i: 4, j: 1 }, { i: 9, j: 1 }, { i: 10, j: 1 }, { i: 7, j: 1 }, { i: 12, j: 1 }, { i: 13, j: 1 }, { i: 14, j: 1 }, { i: 15, j: 1 }, { i: 16, j: 1 }, { i: 17, j: 1 }, { i: 18, j: 1 }, { i: 6, j: 1 }, { i: 12, j: 3 }, { i: 21, j: 1 }, { i: 22, j: 1 }, { i: 15, j: 3 }, { i: 11, j: 1 }, { i: 1, j: 2 }, { i: 2, j: 2 }, { i: 3, j: 2 }, { i: 4, j: 2 }, { i: 5, j: 2 }, { i: 6, j: 2 }, { i: 7, j: 2 }, { i: 19, j: 1 }, { i: 9, j: 2 }, { i: 10, j: 2 }, { i: 11, j: 2 }, { i: 12, j: 2 }, { i: 13, j: 2 }, { i: 14, j: 2 }, { i: 15, j: 2 }, { i: 16, j: 2 }, { i: 17, j: 2 }, { i: 18, j: 2 }, { i: 19, j: 2 }, { i: 12, j: 4 }, { i: 21, j: 2 }, { i: 22, j: 2 }, { i: 15, j: 4 }, { i: 8, j: 1 }, { i: 1, j: 3 }, { i: 2, j: 3 }, { i: 3, j: 3 }, { i: 4, j: 3 }, { i: 5, j: 3 }, { i: 6, j: 3 }, { i: 7, j: 3 }, { i: 8, j: 3 }, { i: 9, j: 3 }, { i: 10, j: 3 }, { i: 11, j: 3 }, { i: 1, j: 4 }, { i: 13, j: 3 }, { i: 14, j: 3 }, { i: 4, j: 4 }, { i: 16, j: 3 }, { i: 17, j: 3 }, { i: 18, j: 3 }, { i: 19, j: 3 }, { i: 9, j: 4 }, { i: 21, j: 3 }, { i: 22, j: 3 }, { i: 3, j: 4 }, { i: 8, j: 2 }, { i: 14, j: 4 }, { i: 2, j: 4 }, { i: 7, j: 4 }, { i: 17, j: 4 }, { i: 5, j: 4 }, { i: 6, j: 4 }, { i: 11, j: 4 }, { i: 8, j: 4 }, { i: 22, j: 4 }, { i: 10, j: 4 }, { i: 19, j: 4 }, { i: 16, j: 4 }, { i: 13, j: 4 }, { i: 18, j: 4 }, { i: 21, j: 4 },  ], css_id: 'tinytable_css_ekj6iyfnh8dj0wylh3r4',}, 
          { positions: [ { i: 0, j: 1 }, { i: 0, j: 4 }, { i: 0, j: 2 }, { i: 0, j: 3 },  ], css_id: 'tinytable_css_6ts1hxy950r1gpup7ful',}, 
          { positions: [ { i: 0, j: 0 },  ], css_id: 'tinytable_css_3991ghrqpmuamd29egtw',}, 
          ];

          // Loop over the arrays to style the cells
          cellsToStyle.forEach(function (group) {
              group.positions.forEach(function (cell) {
                  styleCell_hpxwle723b9tjj7db5ip(cell.i, cell.j, group.css_id);
              });
          });
      });
    </script>

    <style>
      /* tinytable css entries after */
      .table td.tinytable_css_wqjmlofecvwgjgrsqrp0, .table th.tinytable_css_wqjmlofecvwgjgrsqrp0 { text-align: left; border-bottom: solid black 0.05em; }
      .table td.tinytable_css_rnyu0f1x5olh9b2rzgbq, .table th.tinytable_css_rnyu0f1x5olh9b2rzgbq { text-align: center; border-bottom: solid black 0.05em; }
      .table td.tinytable_css_qud0t3dow26d75cy6lqf, .table th.tinytable_css_qud0t3dow26d75cy6lqf { text-align: left; }
      .table td.tinytable_css_orbjpn3xc26nh1et9dit, .table th.tinytable_css_orbjpn3xc26nh1et9dit { text-align: left; border-bottom: solid #d3d8dc 0.1em; }
      .table td.tinytable_css_hhl4syhq4pmcmnnmbiu0, .table th.tinytable_css_hhl4syhq4pmcmnnmbiu0 { text-align: center; border-bottom: solid #d3d8dc 0.1em; }
      .table td.tinytable_css_ekj6iyfnh8dj0wylh3r4, .table th.tinytable_css_ekj6iyfnh8dj0wylh3r4 { text-align: center; }
      .table td.tinytable_css_6ts1hxy950r1gpup7ful, .table th.tinytable_css_6ts1hxy950r1gpup7ful { text-align: center; border-top: solid #d3d8dc 0.1em; border-bottom: solid #d3d8dc 0.05em; }
      .table td.tinytable_css_3991ghrqpmuamd29egtw, .table th.tinytable_css_3991ghrqpmuamd29egtw { text-align: left; border-top: solid #d3d8dc 0.1em; border-bottom: solid #d3d8dc 0.05em; }
    </style>
    <div class="container">
      <table class="table table-borderless" id="tinytable_hpxwle723b9tjj7db5ip" style="width: auto; margin-left: auto; margin-right: auto;" data-quarto-disable-processing="true">
        <thead>
        
              <tr>
                <th scope="col"> </th>
                <th scope="col">MH (単回帰)</th>
                <th scope="col">MH (重回帰)</th>
                <th scope="col">PS (単回帰)</th>
                <th scope="col">PS (重回帰)</th>
              </tr>
        </thead>
        
        <tbody>
                <tr>
                  <td>(Intercept)</td>
                  <td>5953.896</td>
                  <td>1367.609</td>
                  <td>4357.528</td>
                  <td>-1268.481</td>
                </tr>
                <tr>
                  <td></td>
                  <td>(832.765)</td>
                  <td>(4742.325)</td>
                  <td>(798.432)</td>
                  <td>(4329.104)</td>
                </tr>
                <tr>
                  <td>treat</td>
                  <td>395.247</td>
                  <td>319.158</td>
                  <td>1991.615</td>
                  <td>1926.426</td>
                </tr>
                <tr>
                  <td></td>
                  <td>(992.921)</td>
                  <td>(989.821)</td>
                  <td>(959.197)</td>
                  <td>(962.213)</td>
                </tr>
                <tr>
                  <td>age</td>
                  <td></td>
                  <td>0.738</td>
                  <td></td>
                  <td>43.983</td>
                </tr>
                <tr>
                  <td></td>
                  <td></td>
                  <td>(63.289)</td>
                  <td></td>
                  <td>(59.595)</td>
                </tr>
                <tr>
                  <td>educ</td>
                  <td></td>
                  <td>513.097</td>
                  <td></td>
                  <td>462.507</td>
                </tr>
                <tr>
                  <td></td>
                  <td></td>
                  <td>(315.294)</td>
                  <td></td>
                  <td>(275.406)</td>
                </tr>
                <tr>
                  <td>black</td>
                  <td></td>
                  <td>-1441.462</td>
                  <td></td>
                  <td>-892.421</td>
                </tr>
                <tr>
                  <td></td>
                  <td></td>
                  <td>(1547.443)</td>
                  <td></td>
                  <td>(1526.070)</td>
                </tr>
                <tr>
                  <td>hispanic</td>
                  <td></td>
                  <td>47.198</td>
                  <td></td>
                  <td>-171.481</td>
                </tr>
                <tr>
                  <td></td>
                  <td></td>
                  <td>(2391.301)</td>
                  <td></td>
                  <td>(2323.016)</td>
                </tr>
                <tr>
                  <td>married</td>
                  <td></td>
                  <td>294.628</td>
                  <td></td>
                  <td>282.877</td>
                </tr>
                <tr>
                  <td></td>
                  <td></td>
                  <td>(1268.718)</td>
                  <td></td>
                  <td>(1282.599)</td>
                </tr>
                <tr>
                  <td>nodegree</td>
                  <td></td>
                  <td>17.309</td>
                  <td></td>
                  <td>159.611</td>
                </tr>
                <tr>
                  <td></td>
                  <td></td>
                  <td>(1401.818)</td>
                  <td></td>
                  <td>(1367.608)</td>
                </tr>
                <tr>
                  <td>re74</td>
                  <td></td>
                  <td>0.082</td>
                  <td></td>
                  <td>0.056</td>
                </tr>
                <tr>
                  <td></td>
                  <td></td>
                  <td>(0.132)</td>
                  <td></td>
                  <td>(0.121)</td>
                </tr>
                <tr>
                  <td>re75</td>
                  <td></td>
                  <td>0.200</td>
                  <td></td>
                  <td>0.163</td>
                </tr>
                <tr>
                  <td></td>
                  <td></td>
                  <td>(0.205)</td>
                  <td></td>
                  <td>(0.198)</td>
                </tr>
                <tr>
                  <td>Num.Obs.</td>
                  <td>263</td>
                  <td>263</td>
                  <td>267</td>
                  <td>267</td>
                </tr>
                <tr>
                  <td>R2</td>
                  <td>0.001</td>
                  <td>0.043</td>
                  <td>0.016</td>
                  <td>0.053</td>
                </tr>
                <tr>
                  <td>R2 Adj.</td>
                  <td>-0.003</td>
                  <td>0.009</td>
                  <td>0.012</td>
                  <td>0.020</td>
                </tr>
        </tbody>
      </table>
    </div>
<!-- hack to avoid NA insertion in last line -->
</div>
</div>
<p>　傾向スコアマッチングでも正の処置効果（ATT）が確認され、今回は統計的に有意な結果が得られている。</p>
</section>
<section id="cem" class="level3">
<h3 class="anchored" data-anchor-id="cem">CEM</h3>
<p>　Coarsened Exact Matching（CEM）はマハラノビス最近傍マッチング同様、<code>matchit()</code>関数を使うが、事前に{cem}パッケージをインストールしておく必要がある（<code>install.pacakges("cem")</code>）。</p>
<p>　CEMのようなExact Matching類の手法は距離を図る必要がないので、<code>distance</code>引数は不要である。マッチング方法を指定する<code>method</code>引数はこれまで使ってきた<code>"nearest"</code>（最近傍）でなく、<code>"cem"</code>に替えよう。推定可能な処置効果はATE（最近傍マッチングでは指定できなかったもの）、ATT、ATCであるが、ここではAT<strong>T</strong>を推定してみよう。</p>
<p>　マッチングをしたら<code>match.data()</code>でマッチングされたデータを抽出する。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1"></a>cem_mat <span class="ot">&lt;-</span> <span class="fu">matchit</span>(treat <span class="sc">~</span> age <span class="sc">+</span> educ <span class="sc">+</span> black <span class="sc">+</span> hispanic <span class="sc">+</span> married <span class="sc">+</span> </span>
<span id="cb44-2"><a href="#cb44-2"></a>                     nodegree <span class="sc">+</span> re74 <span class="sc">+</span> re75, <span class="at">data =</span> la_df,</span>
<span id="cb44-3"><a href="#cb44-3"></a>                   <span class="at">method =</span> <span class="st">"cem"</span>, <span class="at">estimand =</span> <span class="st">"ATT"</span>)</span></code><button title="コピー" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>　つづいて、{cobalt}の<code>love.plot()</code>を使用して、バランスチェックを行う。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1"></a><span class="fu">love.plot</span>(cem_mat, <span class="at">thresholds =</span> <span class="fl">0.25</span>, <span class="at">abs =</span> <span class="cn">TRUE</span>)</span></code><button title="コピー" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="matching_files/figure-html/unnamed-chunk-35-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="1050"></p>
</figure>
</div>
</div>
</div>
<p>　CEMの場合、（非復元）最近傍マッチングよりもバランスが大きく改善されることが分かる。その理由は簡単だ。最近傍マッチングの場合、最も近いケースであれば、どれほど離れていてもマッチングされる。一方、CEMは正確マッチングの一種であるため、ある程度離れているケースを捨ててしまうため、結局は共変量が非常に近いケースのみを残すことになります。</p>
<p>　それでは、<code>match.data()</code>関数を使ってマッチング後のデータを抽出してみよう。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb46-1"><a href="#cb46-1"></a>cem_data <span class="ot">&lt;-</span> <span class="fu">match.data</span>(cem_mat)</span>
<span id="cb46-2"><a href="#cb46-2"></a></span>
<span id="cb46-3"><a href="#cb46-3"></a>cem_data</span></code><button title="コピー" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 140 × 13
   treat   age  educ black hispanic white married nodegree  re74  re75   re78
   &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;int&gt;    &lt;int&gt; &lt;int&gt;   &lt;int&gt;    &lt;int&gt; &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt;
 1     1    22     9     0        1     0       0        1     0     0  3596.
 2     1    27    11     1        0     0       0        1     0     0  7506.
 3     1    22     9     1        0     0       0        1     0     0  4056.
 4     1    23    12     1        0     0       0        0     0     0     0 
 5     1    22    16     1        0     0       0        0     0     0  2164.
 6     1    19     9     1        0     0       0        1     0     0  8174.
 7     1    21    13     1        0     0       0        0     0     0 17095.
 8     1    18     8     1        0     0       0        1     0     0     0 
 9     1    17     7     1        0     0       0        1     0     0  3024.
10     1    19    10     1        0     0       0        1     0     0  3229.
# ℹ 130 more rows
# ℹ 2 more variables: weights &lt;dbl&gt;, subclass &lt;fct&gt;</code></pre>
</div>
</div>
<p>　CEMの場合、マッチングされないブロックは捨てられるため、マハラノビス距離最近傍マッチングよりもサンプルサイズが小さくなりやすい。マッチング相手がなければ、たとえ処置群だとしても除外される。また、処置群と統制群のサンプルサイズも不均衡になる。マッチング結果を見ると、処置群からは65ケース、統制群からは75サンプルのみ残っている。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb48-1"><a href="#cb48-1"></a>cem_data <span class="sc">|&gt;</span></span>
<span id="cb48-2"><a href="#cb48-2"></a>  <span class="fu">count</span>(treat)</span></code><button title="コピー" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 2 × 2
  treat     n
  &lt;int&gt; &lt;int&gt;
1     0    75
2     1    65</code></pre>
</div>
</div>
<p>　処置効果はこれまでの復元マッチングと同様、重み付き回帰分析で推定するｙ。ここでも共変量ありとなし、2パターンで推定してみよう。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb50-1"><a href="#cb50-1"></a>cem_fit1 <span class="ot">&lt;-</span> <span class="fu">lm</span>(re78 <span class="sc">~</span> treat, </span>
<span id="cb50-2"><a href="#cb50-2"></a>               <span class="at">data =</span> cem_data, <span class="at">weights =</span> weights)</span>
<span id="cb50-3"><a href="#cb50-3"></a>cem_fit2 <span class="ot">&lt;-</span> <span class="fu">lm</span>(re78 <span class="sc">~</span> treat <span class="sc">+</span> age <span class="sc">+</span> educ <span class="sc">+</span> black <span class="sc">+</span> hispanic <span class="sc">+</span></span>
<span id="cb50-4"><a href="#cb50-4"></a>                 married <span class="sc">+</span> nodegree <span class="sc">+</span> re74 <span class="sc">+</span> re75, </span>
<span id="cb50-5"><a href="#cb50-5"></a>               <span class="at">data =</span> cem_data, <span class="at">weights =</span> weights)</span>
<span id="cb50-6"><a href="#cb50-6"></a></span>
<span id="cb50-7"><a href="#cb50-7"></a><span class="fu">modelsummary</span>(<span class="fu">list</span>(<span class="st">"MH (単回帰)"</span>   <span class="ot">=</span> mh_fit3,</span>
<span id="cb50-8"><a href="#cb50-8"></a>                  <span class="st">"MH (重回帰)"</span>   <span class="ot">=</span> mh_fit4,</span>
<span id="cb50-9"><a href="#cb50-9"></a>                  <span class="st">"PS (単回帰)"</span>   <span class="ot">=</span> ps_fit1,</span>
<span id="cb50-10"><a href="#cb50-10"></a>                  <span class="st">"PS (重回帰)"</span>   <span class="ot">=</span> ps_fit2,</span>
<span id="cb50-11"><a href="#cb50-11"></a>                  <span class="st">"CEM (単回帰)"</span>  <span class="ot">=</span> cem_fit1,</span>
<span id="cb50-12"><a href="#cb50-12"></a>                  <span class="st">"CEM (重回帰)"</span>  <span class="ot">=</span> cem_fit2), </span>
<span id="cb50-13"><a href="#cb50-13"></a>             <span class="at">gof_map   =</span> <span class="fu">c</span>(<span class="st">"nobs"</span>, <span class="st">"r.squared"</span>, <span class="st">"adj.r.squared"</span>))</span></code><button title="コピー" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<!-- preamble start -->

    <script>

      function styleCell_y3fuo31dszi076qz2lf1(i, j, css_id) {
          var table = document.getElementById("tinytable_y3fuo31dszi076qz2lf1");
          var cell = table.rows[i]?.cells[j];  // Safe navigation to avoid errors
          if (cell) {
              console.log(`Styling cell at (${i}, ${j}) with class ${css_id}`);
              cell.classList.add(css_id);
          } else {
              console.warn(`Cell at (${i}, ${j}) not found.`);
          }
      }
      function insertSpanRow(i, colspan, content) {
        var table = document.getElementById('tinytable_y3fuo31dszi076qz2lf1');
        var newRow = table.insertRow(i);
        var newCell = newRow.insertCell(0);
        newCell.setAttribute("colspan", colspan);
        // newCell.innerText = content;
        // this may be unsafe, but innerText does not interpret <br>
        newCell.innerHTML = content;
      }
      function spanCell_y3fuo31dszi076qz2lf1(i, j, rowspan, colspan) {
        var table = document.getElementById("tinytable_y3fuo31dszi076qz2lf1");
        const targetRow = table.rows[i];
        const targetCell = targetRow.cells[j];
        for (let r = 0; r < rowspan; r++) {
          // Only start deleting cells to the right for the first row (r == 0)
          if (r === 0) {
            // Delete cells to the right of the target cell in the first row
            for (let c = colspan - 1; c > 0; c--) {
              if (table.rows[i + r].cells[j + c]) {
                table.rows[i + r].deleteCell(j + c);
              }
            }
          }
          // For rows below the first, delete starting from the target column
          if (r > 0) {
            for (let c = colspan - 1; c >= 0; c--) {
              if (table.rows[i + r] && table.rows[i + r].cells[j]) {
                table.rows[i + r].deleteCell(j);
              }
            }
          }
        }
        // Set rowspan and colspan of the target cell
        targetCell.rowSpan = rowspan;
        targetCell.colSpan = colspan;
      }
      // tinytable span after
      window.addEventListener('load', function () {
          var cellsToStyle = [
            // tinytable style arrays after
          { positions: [ { i: 20, j: 0 },  ], css_id: 'tinytable_css_yd8cpk70m8edd7ni43r1',}, 
          { positions: [ { i: 5, j: 1 }, { i: 2, j: 1 }, { i: 4, j: 1 }, { i: 9, j: 1 }, { i: 10, j: 1 }, { i: 7, j: 1 }, { i: 12, j: 1 }, { i: 13, j: 1 }, { i: 1, j: 1 }, { i: 15, j: 1 }, { i: 3, j: 1 }, { i: 17, j: 1 }, { i: 18, j: 1 }, { i: 6, j: 1 }, { i: 12, j: 3 }, { i: 21, j: 1 }, { i: 22, j: 1 }, { i: 15, j: 3 }, { i: 11, j: 1 }, { i: 1, j: 2 }, { i: 2, j: 2 }, { i: 14, j: 1 }, { i: 4, j: 2 }, { i: 5, j: 2 }, { i: 6, j: 2 }, { i: 7, j: 2 }, { i: 19, j: 1 }, { i: 9, j: 2 }, { i: 10, j: 2 }, { i: 11, j: 2 }, { i: 12, j: 2 }, { i: 13, j: 2 }, { i: 14, j: 2 }, { i: 15, j: 2 }, { i: 3, j: 2 }, { i: 17, j: 2 }, { i: 18, j: 2 }, { i: 19, j: 2 }, { i: 12, j: 4 }, { i: 21, j: 2 }, { i: 22, j: 2 }, { i: 15, j: 4 }, { i: 8, j: 1 }, { i: 1, j: 3 }, { i: 2, j: 3 }, { i: 3, j: 3 }, { i: 4, j: 3 }, { i: 5, j: 3 }, { i: 6, j: 3 }, { i: 7, j: 3 }, { i: 16, j: 1 }, { i: 9, j: 3 }, { i: 10, j: 3 }, { i: 11, j: 3 }, { i: 4, j: 5 }, { i: 13, j: 3 }, { i: 14, j: 3 }, { i: 7, j: 5 }, { i: 16, j: 3 }, { i: 17, j: 3 }, { i: 18, j: 3 }, { i: 19, j: 3 }, { i: 12, j: 5 }, { i: 21, j: 3 }, { i: 22, j: 3 }, { i: 15, j: 5 }, { i: 8, j: 2 }, { i: 1, j: 4 }, { i: 2, j: 4 }, { i: 3, j: 4 }, { i: 4, j: 4 }, { i: 5, j: 4 }, { i: 6, j: 4 }, { i: 7, j: 4 }, { i: 16, j: 2 }, { i: 9, j: 4 }, { i: 10, j: 4 }, { i: 11, j: 4 }, { i: 4, j: 6 }, { i: 13, j: 4 }, { i: 14, j: 4 }, { i: 7, j: 6 }, { i: 16, j: 4 }, { i: 17, j: 4 }, { i: 18, j: 4 }, { i: 19, j: 4 }, { i: 12, j: 6 }, { i: 21, j: 4 }, { i: 22, j: 4 }, { i: 15, j: 6 }, { i: 8, j: 3 }, { i: 1, j: 5 }, { i: 2, j: 5 }, { i: 3, j: 5 }, { i: 17, j: 5 }, { i: 5, j: 5 }, { i: 6, j: 5 }, { i: 9, j: 6 }, { i: 8, j: 5 }, { i: 9, j: 5 }, { i: 10, j: 5 }, { i: 11, j: 5 }, { i: 1, j: 6 }, { i: 13, j: 5 }, { i: 14, j: 5 }, { i: 17, j: 6 }, { i: 16, j: 5 }, { i: 6, j: 6 }, { i: 18, j: 5 }, { i: 19, j: 5 }, { i: 22, j: 6 }, { i: 21, j: 5 }, { i: 22, j: 5 }, { i: 3, j: 6 }, { i: 8, j: 4 }, { i: 14, j: 6 }, { i: 2, j: 6 }, { i: 11, j: 6 }, { i: 8, j: 6 }, { i: 5, j: 6 }, { i: 19, j: 6 }, { i: 16, j: 6 }, { i: 13, j: 6 }, { i: 10, j: 6 }, { i: 21, j: 6 }, { i: 18, j: 6 },  ], css_id: 'tinytable_css_vm93xpn69zdjhy1y7f24',}, 
          { positions: [ { i: 0, j: 0 },  ], css_id: 'tinytable_css_turw7h00v9gt2lm5dbeu',}, 
          { positions: [ { i: 20, j: 4 }, { i: 20, j: 6 }, { i: 20, j: 2 }, { i: 20, j: 1 }, { i: 20, j: 5 }, { i: 20, j: 3 },  ], css_id: 'tinytable_css_rkz7o2mo2l8usgo6m2r1',}, 
          { positions: [ { i: 23, j: 5 }, { i: 23, j: 4 }, { i: 23, j: 2 }, { i: 23, j: 3 }, { i: 23, j: 1 }, { i: 23, j: 6 },  ], css_id: 'tinytable_css_oxvh6v5vf8gk3u9sr3uq',}, 
          { positions: [ { i: 1, j: 0 }, { i: 2, j: 0 }, { i: 3, j: 0 }, { i: 4, j: 0 }, { i: 5, j: 0 }, { i: 6, j: 0 }, { i: 7, j: 0 }, { i: 8, j: 0 }, { i: 9, j: 0 }, { i: 10, j: 0 }, { i: 11, j: 0 }, { i: 12, j: 0 }, { i: 13, j: 0 }, { i: 14, j: 0 }, { i: 15, j: 0 }, { i: 16, j: 0 }, { i: 17, j: 0 }, { i: 18, j: 0 }, { i: 19, j: 0 }, { i: 21, j: 0 }, { i: 22, j: 0 },  ], css_id: 'tinytable_css_odr6m58l51n4umz6vfhu',}, 
          { positions: [ { i: 23, j: 0 },  ], css_id: 'tinytable_css_eg3evprdij4t0vnjqyup',}, 
          { positions: [ { i: 0, j: 1 }, { i: 0, j: 6 }, { i: 0, j: 4 }, { i: 0, j: 5 }, { i: 0, j: 3 }, { i: 0, j: 2 },  ], css_id: 'tinytable_css_0kecep03j3kkvcg0nh9a',}, 
          ];

          // Loop over the arrays to style the cells
          cellsToStyle.forEach(function (group) {
              group.positions.forEach(function (cell) {
                  styleCell_y3fuo31dszi076qz2lf1(cell.i, cell.j, group.css_id);
              });
          });
      });
    </script>

    <style>
      /* tinytable css entries after */
      .table td.tinytable_css_yd8cpk70m8edd7ni43r1, .table th.tinytable_css_yd8cpk70m8edd7ni43r1 { text-align: left; border-bottom: solid black 0.05em; }
      .table td.tinytable_css_vm93xpn69zdjhy1y7f24, .table th.tinytable_css_vm93xpn69zdjhy1y7f24 { text-align: center; }
      .table td.tinytable_css_turw7h00v9gt2lm5dbeu, .table th.tinytable_css_turw7h00v9gt2lm5dbeu { text-align: left; border-top: solid #d3d8dc 0.1em; border-bottom: solid #d3d8dc 0.05em; }
      .table td.tinytable_css_rkz7o2mo2l8usgo6m2r1, .table th.tinytable_css_rkz7o2mo2l8usgo6m2r1 { text-align: center; border-bottom: solid black 0.05em; }
      .table td.tinytable_css_oxvh6v5vf8gk3u9sr3uq, .table th.tinytable_css_oxvh6v5vf8gk3u9sr3uq { text-align: center; border-bottom: solid #d3d8dc 0.1em; }
      .table td.tinytable_css_odr6m58l51n4umz6vfhu, .table th.tinytable_css_odr6m58l51n4umz6vfhu { text-align: left; }
      .table td.tinytable_css_eg3evprdij4t0vnjqyup, .table th.tinytable_css_eg3evprdij4t0vnjqyup { text-align: left; border-bottom: solid #d3d8dc 0.1em; }
      .table td.tinytable_css_0kecep03j3kkvcg0nh9a, .table th.tinytable_css_0kecep03j3kkvcg0nh9a { text-align: center; border-top: solid #d3d8dc 0.1em; border-bottom: solid #d3d8dc 0.05em; }
    </style>
    <div class="container">
      <table class="table table-borderless" id="tinytable_y3fuo31dszi076qz2lf1" style="width: auto; margin-left: auto; margin-right: auto;" data-quarto-disable-processing="true">
        <thead>
        
              <tr>
                <th scope="col"> </th>
                <th scope="col">MH (単回帰)</th>
                <th scope="col">MH (重回帰)</th>
                <th scope="col">PS (単回帰)</th>
                <th scope="col">PS (重回帰)</th>
                <th scope="col">CEM (単回帰)</th>
                <th scope="col">CEM (重回帰)</th>
              </tr>
        </thead>
        
        <tbody>
                <tr>
                  <td>(Intercept)</td>
                  <td>5953.896</td>
                  <td>1367.609</td>
                  <td>4357.528</td>
                  <td>-1268.481</td>
                  <td>5265.785</td>
                  <td>-7253.717</td>
                </tr>
                <tr>
                  <td></td>
                  <td>(832.765)</td>
                  <td>(4742.325)</td>
                  <td>(798.432)</td>
                  <td>(4329.104)</td>
                  <td>(850.457)</td>
                  <td>(7031.576)</td>
                </tr>
                <tr>
                  <td>treat</td>
                  <td>395.247</td>
                  <td>319.158</td>
                  <td>1991.615</td>
                  <td>1926.426</td>
                  <td>1070.907</td>
                  <td>1207.183</td>
                </tr>
                <tr>
                  <td></td>
                  <td>(992.921)</td>
                  <td>(989.821)</td>
                  <td>(959.197)</td>
                  <td>(962.213)</td>
                  <td>(1248.129)</td>
                  <td>(1245.959)</td>
                </tr>
                <tr>
                  <td>age</td>
                  <td></td>
                  <td>0.738</td>
                  <td></td>
                  <td>43.983</td>
                  <td></td>
                  <td>147.970</td>
                </tr>
                <tr>
                  <td></td>
                  <td></td>
                  <td>(63.289)</td>
                  <td></td>
                  <td>(59.595)</td>
                  <td></td>
                  <td>(107.716)</td>
                </tr>
                <tr>
                  <td>educ</td>
                  <td></td>
                  <td>513.097</td>
                  <td></td>
                  <td>462.507</td>
                  <td></td>
                  <td>879.978</td>
                </tr>
                <tr>
                  <td></td>
                  <td></td>
                  <td>(315.294)</td>
                  <td></td>
                  <td>(275.406)</td>
                  <td></td>
                  <td>(472.982)</td>
                </tr>
                <tr>
                  <td>black</td>
                  <td></td>
                  <td>-1441.462</td>
                  <td></td>
                  <td>-892.421</td>
                  <td></td>
                  <td>-1941.465</td>
                </tr>
                <tr>
                  <td></td>
                  <td></td>
                  <td>(1547.443)</td>
                  <td></td>
                  <td>(1526.070)</td>
                  <td></td>
                  <td>(2485.215)</td>
                </tr>
                <tr>
                  <td>hispanic</td>
                  <td></td>
                  <td>47.198</td>
                  <td></td>
                  <td>-171.481</td>
                  <td></td>
                  <td>437.208</td>
                </tr>
                <tr>
                  <td></td>
                  <td></td>
                  <td>(2391.301)</td>
                  <td></td>
                  <td>(2323.016)</td>
                  <td></td>
                  <td>(4223.958)</td>
                </tr>
                <tr>
                  <td>married</td>
                  <td></td>
                  <td>294.628</td>
                  <td></td>
                  <td>282.877</td>
                  <td></td>
                  <td>-3213.470</td>
                </tr>
                <tr>
                  <td></td>
                  <td></td>
                  <td>(1268.718)</td>
                  <td></td>
                  <td>(1282.599)</td>
                  <td></td>
                  <td>(4445.151)</td>
                </tr>
                <tr>
                  <td>nodegree</td>
                  <td></td>
                  <td>17.309</td>
                  <td></td>
                  <td>159.611</td>
                  <td></td>
                  <td>1779.900</td>
                </tr>
                <tr>
                  <td></td>
                  <td></td>
                  <td>(1401.818)</td>
                  <td></td>
                  <td>(1367.608)</td>
                  <td></td>
                  <td>(2019.035)</td>
                </tr>
                <tr>
                  <td>re74</td>
                  <td></td>
                  <td>0.082</td>
                  <td></td>
                  <td>0.056</td>
                  <td></td>
                  <td>-0.262</td>
                </tr>
                <tr>
                  <td></td>
                  <td></td>
                  <td>(0.132)</td>
                  <td></td>
                  <td>(0.121)</td>
                  <td></td>
                  <td>(0.601)</td>
                </tr>
                <tr>
                  <td>re75</td>
                  <td></td>
                  <td>0.200</td>
                  <td></td>
                  <td>0.163</td>
                  <td></td>
                  <td>2.034</td>
                </tr>
                <tr>
                  <td></td>
                  <td></td>
                  <td>(0.205)</td>
                  <td></td>
                  <td>(0.198)</td>
                  <td></td>
                  <td>(0.883)</td>
                </tr>
                <tr>
                  <td>Num.Obs.</td>
                  <td>263</td>
                  <td>263</td>
                  <td>267</td>
                  <td>267</td>
                  <td>140</td>
                  <td>140</td>
                </tr>
                <tr>
                  <td>R2</td>
                  <td>0.001</td>
                  <td>0.043</td>
                  <td>0.016</td>
                  <td>0.053</td>
                  <td>0.005</td>
                  <td>0.079</td>
                </tr>
                <tr>
                  <td>R2 Adj.</td>
                  <td>-0.003</td>
                  <td>0.009</td>
                  <td>0.012</td>
                  <td>0.020</td>
                  <td>-0.002</td>
                  <td>0.015</td>
                </tr>
        </tbody>
      </table>
    </div>
<!-- hack to avoid NA insertion in last line -->
</div>
</div>
<p>　推定の結果は、いずれも正であり、職業訓練は所得に正の影響を与えるという結果が得られている。しかし、いずれも標準誤差が非常に大きく、統計的に有意な結果は得られていない。</p>
</section>
</section>
<section id="ipw" class="level2">
<h2 class="anchored" data-anchor-id="ipw">IPW</h2>
<p>　最後に、{WeightIt}パッケージを使ってIPW推定を行ってみよう。このパッケージはこれまで使ってた{MatchIt}パッケージと非常に似ている。まず、第一引数として処置変数を結果変数、処置有無に影響を与えると考えられる共変量を説明変数とした回帰式を入れる。続いて、データ（<code>data</code>）、IPW算出の方法（<code>method</code>）、推定の対象（<code>estimand</code>）を指定する。データは<code>data = la_df</code>とし、傾向スコアからIPWを算出するため<code>method = "ps"</code>を指定、最後にATT推定のために<code>estimand = "ATT"</code>を指定する。今回はIPW算出のために今回は傾向スコアを使うが、「処置を受ける確率」が計算できるなら何でも良い。たとえば、Imai and Ratkovic (2014)<a href="#fn8" class="footnote-ref" id="fnref8" role="doc-noteref"><sup>8</sup></a>が推奨しているCovariate Balancing Propensity Score (CBPS) を使用する場合は<code>"ps"</code>の代わりに<code>"cbps"</code>を、複数の推定を組み合わせるスーパーラーニングをする場合は<code>"super"</code><a href="#fn9" class="footnote-ref" id="fnref9" role="doc-noteref"><sup>9</sup></a>などが使える。他にもエントロピーバランシングなど様々なオプションが提供されている。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb51-1"><a href="#cb51-1"></a>ipw_data <span class="ot">&lt;-</span> <span class="fu">weightit</span>(treat <span class="sc">~</span> age <span class="sc">+</span> educ <span class="sc">+</span> black <span class="sc">+</span> hispanic <span class="sc">+</span> </span>
<span id="cb51-2"><a href="#cb51-2"></a>                       married <span class="sc">+</span> nodegree <span class="sc">+</span> re74 <span class="sc">+</span> re75, </span>
<span id="cb51-3"><a href="#cb51-3"></a>                     <span class="at">data =</span> la_df, <span class="at">method =</span> <span class="st">"ps"</span>, <span class="at">estimand =</span> <span class="st">"ATT"</span>)</span></code><button title="コピー" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>　<code>matchit()</code>とは違って、別途<code>match.data()</code>などの関数は不要である。<code>weightit()</code>パッケージを使うと、IPW推定のための重み変数を返してくれる。また、<code>weightit()</code>から得られたデータは{cobalt}でバランスチェックもできる。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb52-1"><a href="#cb52-1"></a><span class="fu">love.plot</span>(ipw_data, <span class="at">thresholds =</span> <span class="fl">0.25</span>, <span class="at">abs =</span> <span class="cn">TRUE</span>)</span></code><button title="コピー" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="matching_files/figure-html/unnamed-chunk-40-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="1050"></p>
</figure>
</div>
</div>
</div>
<p>　読み方は最近傍マッチング（傾向スコア）と同じである。ここでもバランスが大幅に改善されていることが分かる。</p>
<p>　それではIPW推定量を計算してみよう。ここで一つ注意が必要だ。それは<code>data</code>を<code>ipw_data</code>でなく、元のデータである<code>la_df</code>を使うという点だ。また、重み変数は<code>la_df</code>には含まれていないため、<code>ipw_data$weights</code>を使う必要がある。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb53-1"><a href="#cb53-1"></a>ipw_fit1 <span class="ot">&lt;-</span> <span class="fu">lm</span>(re78 <span class="sc">~</span> treat, </span>
<span id="cb53-2"><a href="#cb53-2"></a>               <span class="at">data =</span> la_df, <span class="at">weights =</span> ipw_data<span class="sc">$</span>weights)</span>
<span id="cb53-3"><a href="#cb53-3"></a>ipw_fit2 <span class="ot">&lt;-</span> <span class="fu">lm</span>(re78 <span class="sc">~</span> treat <span class="sc">+</span> age <span class="sc">+</span> educ <span class="sc">+</span> black <span class="sc">+</span> hispanic <span class="sc">+</span> </span>
<span id="cb53-4"><a href="#cb53-4"></a>                       married <span class="sc">+</span> nodegree <span class="sc">+</span> re74 <span class="sc">+</span> re75, </span>
<span id="cb53-5"><a href="#cb53-5"></a>               <span class="at">data =</span> la_df, <span class="at">weights =</span> ipw_data<span class="sc">$</span>weights)</span>
<span id="cb53-6"><a href="#cb53-6"></a></span>
<span id="cb53-7"><a href="#cb53-7"></a><span class="fu">modelsummary</span>(<span class="fu">list</span>(<span class="st">"MH (単)"</span>   <span class="ot">=</span> mh_fit3,</span>
<span id="cb53-8"><a href="#cb53-8"></a>                  <span class="st">"MH (重)"</span>   <span class="ot">=</span> mh_fit4,</span>
<span id="cb53-9"><a href="#cb53-9"></a>                  <span class="st">"PS (単)"</span>   <span class="ot">=</span> ps_fit1,</span>
<span id="cb53-10"><a href="#cb53-10"></a>                  <span class="st">"PS (重)"</span>   <span class="ot">=</span> ps_fit2,</span>
<span id="cb53-11"><a href="#cb53-11"></a>                  <span class="st">"CEM (単)"</span>  <span class="ot">=</span> cem_fit1,</span>
<span id="cb53-12"><a href="#cb53-12"></a>                  <span class="st">"CEM (重)"</span>  <span class="ot">=</span> cem_fit2,</span>
<span id="cb53-13"><a href="#cb53-13"></a>                  <span class="st">"IPW (単)"</span>  <span class="ot">=</span> ipw_fit1,</span>
<span id="cb53-14"><a href="#cb53-14"></a>                  <span class="st">"IPW (重)"</span>  <span class="ot">=</span> ipw_fit2), </span>
<span id="cb53-15"><a href="#cb53-15"></a>             <span class="at">gof_map   =</span> <span class="fu">c</span>(<span class="st">"nobs"</span>, <span class="st">"r.squared"</span>, <span class="st">"adj.r.squared"</span>))</span></code><button title="コピー" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<!-- preamble start -->

    <script>

      function styleCell_3xbil2fyr9ie82ezqsll(i, j, css_id) {
          var table = document.getElementById("tinytable_3xbil2fyr9ie82ezqsll");
          var cell = table.rows[i]?.cells[j];  // Safe navigation to avoid errors
          if (cell) {
              console.log(`Styling cell at (${i}, ${j}) with class ${css_id}`);
              cell.classList.add(css_id);
          } else {
              console.warn(`Cell at (${i}, ${j}) not found.`);
          }
      }
      function insertSpanRow(i, colspan, content) {
        var table = document.getElementById('tinytable_3xbil2fyr9ie82ezqsll');
        var newRow = table.insertRow(i);
        var newCell = newRow.insertCell(0);
        newCell.setAttribute("colspan", colspan);
        // newCell.innerText = content;
        // this may be unsafe, but innerText does not interpret <br>
        newCell.innerHTML = content;
      }
      function spanCell_3xbil2fyr9ie82ezqsll(i, j, rowspan, colspan) {
        var table = document.getElementById("tinytable_3xbil2fyr9ie82ezqsll");
        const targetRow = table.rows[i];
        const targetCell = targetRow.cells[j];
        for (let r = 0; r < rowspan; r++) {
          // Only start deleting cells to the right for the first row (r == 0)
          if (r === 0) {
            // Delete cells to the right of the target cell in the first row
            for (let c = colspan - 1; c > 0; c--) {
              if (table.rows[i + r].cells[j + c]) {
                table.rows[i + r].deleteCell(j + c);
              }
            }
          }
          // For rows below the first, delete starting from the target column
          if (r > 0) {
            for (let c = colspan - 1; c >= 0; c--) {
              if (table.rows[i + r] && table.rows[i + r].cells[j]) {
                table.rows[i + r].deleteCell(j);
              }
            }
          }
        }
        // Set rowspan and colspan of the target cell
        targetCell.rowSpan = rowspan;
        targetCell.colSpan = colspan;
      }
      // tinytable span after
      window.addEventListener('load', function () {
          var cellsToStyle = [
            // tinytable style arrays after
          { positions: [ { i: 23, j: 2 }, { i: 23, j: 7 }, { i: 23, j: 1 }, { i: 23, j: 6 }, { i: 23, j: 4 }, { i: 23, j: 5 }, { i: 23, j: 3 }, { i: 23, j: 8 },  ], css_id: 'tinytable_css_zozhj06y7ngahw5hwotu',}, 
          { positions: [ { i: 20, j: 0 },  ], css_id: 'tinytable_css_sykibmgb7ekkz20i8nc8',}, 
          { positions: [ { i: 0, j: 0 },  ], css_id: 'tinytable_css_ntjevgu6r01190p4n3ro',}, 
          { positions: [ { i: 23, j: 0 },  ], css_id: 'tinytable_css_n03ysfr6bk7f6miw0ach',}, 
          { positions: [ { i: 2, j: 1 }, { i: 5, j: 1 }, { i: 10, j: 1 }, { i: 7, j: 1 }, { i: 4, j: 1 }, { i: 13, j: 1 }, { i: 1, j: 1 }, { i: 15, j: 1 }, { i: 3, j: 1 }, { i: 17, j: 1 }, { i: 18, j: 1 }, { i: 6, j: 1 }, { i: 12, j: 3 }, { i: 21, j: 1 }, { i: 9, j: 1 }, { i: 15, j: 3 }, { i: 11, j: 1 }, { i: 12, j: 1 }, { i: 2, j: 2 }, { i: 14, j: 1 }, { i: 4, j: 2 }, { i: 5, j: 2 }, { i: 6, j: 2 }, { i: 7, j: 2 }, { i: 19, j: 1 }, { i: 9, j: 2 }, { i: 10, j: 2 }, { i: 22, j: 1 }, { i: 12, j: 2 }, { i: 13, j: 2 }, { i: 1, j: 2 }, { i: 15, j: 2 }, { i: 3, j: 2 }, { i: 17, j: 2 }, { i: 18, j: 2 }, { i: 19, j: 2 }, { i: 12, j: 4 }, { i: 21, j: 2 }, { i: 22, j: 2 }, { i: 15, j: 4 }, { i: 11, j: 2 }, { i: 1, j: 3 }, { i: 2, j: 3 }, { i: 14, j: 2 }, { i: 4, j: 3 }, { i: 5, j: 3 }, { i: 6, j: 3 }, { i: 7, j: 3 }, { i: 16, j: 1 }, { i: 9, j: 3 }, { i: 10, j: 3 }, { i: 11, j: 3 }, { i: 4, j: 5 }, { i: 13, j: 3 }, { i: 14, j: 3 }, { i: 7, j: 5 }, { i: 3, j: 3 }, { i: 17, j: 3 }, { i: 18, j: 3 }, { i: 19, j: 3 }, { i: 12, j: 5 }, { i: 21, j: 3 }, { i: 22, j: 3 }, { i: 15, j: 5 }, { i: 8, j: 2 }, { i: 1, j: 4 }, { i: 2, j: 4 }, { i: 3, j: 4 }, { i: 4, j: 4 }, { i: 5, j: 4 }, { i: 6, j: 4 }, { i: 7, j: 4 }, { i: 16, j: 2 }, { i: 9, j: 4 }, { i: 10, j: 4 }, { i: 11, j: 4 }, { i: 4, j: 6 }, { i: 13, j: 4 }, { i: 14, j: 4 }, { i: 7, j: 6 }, { i: 8, j: 1 }, { i: 17, j: 4 }, { i: 18, j: 4 }, { i: 19, j: 4 }, { i: 12, j: 6 }, { i: 21, j: 4 }, { i: 22, j: 4 }, { i: 15, j: 6 }, { i: 8, j: 3 }, { i: 1, j: 5 }, { i: 2, j: 5 }, { i: 3, j: 5 }, { i: 12, j: 8 }, { i: 5, j: 5 }, { i: 6, j: 5 }, { i: 15, j: 8 }, { i: 16, j: 3 }, { i: 9, j: 5 }, { i: 10, j: 5 }, { i: 11, j: 5 }, { i: 4, j: 7 }, { i: 13, j: 5 }, { i: 14, j: 5 }, { i: 7, j: 7 }, { i: 16, j: 5 }, { i: 17, j: 5 }, { i: 18, j: 5 }, { i: 19, j: 5 }, { i: 12, j: 7 }, { i: 21, j: 5 }, { i: 22, j: 5 }, { i: 15, j: 7 }, { i: 8, j: 4 }, { i: 1, j: 6 }, { i: 2, j: 6 }, { i: 3, j: 6 }, { i: 17, j: 6 }, { i: 5, j: 6 }, { i: 6, j: 6 }, { i: 9, j: 7 }, { i: 16, j: 4 }, { i: 9, j: 6 }, { i: 10, j: 6 }, { i: 11, j: 6 }, { i: 4, j: 8 }, { i: 13, j: 6 }, { i: 14, j: 6 }, { i: 7, j: 8 }, { i: 16, j: 6 }, { i: 6, j: 7 }, { i: 18, j: 6 }, { i: 19, j: 6 }, { i: 22, j: 7 }, { i: 21, j: 6 }, { i: 22, j: 6 }, { i: 1, j: 8 }, { i: 8, j: 5 }, { i: 1, j: 7 }, { i: 2, j: 7 }, { i: 3, j: 7 }, { i: 17, j: 7 }, { i: 5, j: 7 }, { i: 19, j: 7 }, { i: 9, j: 8 }, { i: 8, j: 7 }, { i: 11, j: 8 }, { i: 10, j: 7 }, { i: 11, j: 7 }, { i: 14, j: 8 }, { i: 13, j: 7 }, { i: 14, j: 7 }, { i: 17, j: 8 }, { i: 16, j: 7 }, { i: 6, j: 8 }, { i: 18, j: 7 }, { i: 8, j: 8 }, { i: 22, j: 8 }, { i: 21, j: 7 }, { i: 2, j: 8 }, { i: 3, j: 8 }, { i: 8, j: 6 }, { i: 5, j: 8 }, { i: 19, j: 8 }, { i: 21, j: 8 }, { i: 13, j: 8 }, { i: 10, j: 8 }, { i: 16, j: 8 }, { i: 18, j: 8 },  ], css_id: 'tinytable_css_lvilgjkdxwzpfcqec6kx',}, 
          { positions: [ { i: 0, j: 1 }, { i: 0, j: 6 }, { i: 0, j: 4 }, { i: 0, j: 5 }, { i: 0, j: 3 }, { i: 0, j: 8 }, { i: 0, j: 2 }, { i: 0, j: 7 },  ], css_id: 'tinytable_css_hxskvkpkwqan7y44rcoa',}, 
          { positions: [ { i: 1, j: 0 }, { i: 2, j: 0 }, { i: 3, j: 0 }, { i: 4, j: 0 }, { i: 5, j: 0 }, { i: 6, j: 0 }, { i: 7, j: 0 }, { i: 8, j: 0 }, { i: 9, j: 0 }, { i: 10, j: 0 }, { i: 11, j: 0 }, { i: 12, j: 0 }, { i: 13, j: 0 }, { i: 14, j: 0 }, { i: 15, j: 0 }, { i: 16, j: 0 }, { i: 17, j: 0 }, { i: 18, j: 0 }, { i: 19, j: 0 }, { i: 21, j: 0 }, { i: 22, j: 0 },  ], css_id: 'tinytable_css_4r3zf0dp4dqjazcvsd8m',}, 
          { positions: [ { i: 20, j: 6 }, { i: 20, j: 8 }, { i: 20, j: 5 }, { i: 20, j: 3 }, { i: 20, j: 4 }, { i: 20, j: 7 }, { i: 20, j: 1 }, { i: 20, j: 2 },  ], css_id: 'tinytable_css_45nebrzefaol9cyk9m85',}, 
          ];

          // Loop over the arrays to style the cells
          cellsToStyle.forEach(function (group) {
              group.positions.forEach(function (cell) {
                  styleCell_3xbil2fyr9ie82ezqsll(cell.i, cell.j, group.css_id);
              });
          });
      });
    </script>

    <style>
      /* tinytable css entries after */
      .table td.tinytable_css_zozhj06y7ngahw5hwotu, .table th.tinytable_css_zozhj06y7ngahw5hwotu { text-align: center; border-bottom: solid #d3d8dc 0.1em; }
      .table td.tinytable_css_sykibmgb7ekkz20i8nc8, .table th.tinytable_css_sykibmgb7ekkz20i8nc8 { text-align: left; border-bottom: solid black 0.05em; }
      .table td.tinytable_css_ntjevgu6r01190p4n3ro, .table th.tinytable_css_ntjevgu6r01190p4n3ro { text-align: left; border-top: solid #d3d8dc 0.1em; border-bottom: solid #d3d8dc 0.05em; }
      .table td.tinytable_css_n03ysfr6bk7f6miw0ach, .table th.tinytable_css_n03ysfr6bk7f6miw0ach { text-align: left; border-bottom: solid #d3d8dc 0.1em; }
      .table td.tinytable_css_lvilgjkdxwzpfcqec6kx, .table th.tinytable_css_lvilgjkdxwzpfcqec6kx { text-align: center; }
      .table td.tinytable_css_hxskvkpkwqan7y44rcoa, .table th.tinytable_css_hxskvkpkwqan7y44rcoa { text-align: center; border-top: solid #d3d8dc 0.1em; border-bottom: solid #d3d8dc 0.05em; }
      .table td.tinytable_css_4r3zf0dp4dqjazcvsd8m, .table th.tinytable_css_4r3zf0dp4dqjazcvsd8m { text-align: left; }
      .table td.tinytable_css_45nebrzefaol9cyk9m85, .table th.tinytable_css_45nebrzefaol9cyk9m85 { text-align: center; border-bottom: solid black 0.05em; }
    </style>
    <div class="container">
      <table class="table table-borderless" id="tinytable_3xbil2fyr9ie82ezqsll" style="width: auto; margin-left: auto; margin-right: auto;" data-quarto-disable-processing="true">
        <thead>
        
              <tr>
                <th scope="col"> </th>
                <th scope="col">MH (単)</th>
                <th scope="col">MH (重)</th>
                <th scope="col">PS (単)</th>
                <th scope="col">PS (重)</th>
                <th scope="col">CEM (単)</th>
                <th scope="col">CEM (重)</th>
                <th scope="col">IPW (単)</th>
                <th scope="col">IPW (重)</th>
              </tr>
        </thead>
        
        <tbody>
                <tr>
                  <td>(Intercept)</td>
                  <td>5953.896</td>
                  <td>1367.609</td>
                  <td>4357.528</td>
                  <td>-1268.481</td>
                  <td>5265.785</td>
                  <td>-7253.717</td>
                  <td>5135.072</td>
                  <td>853.666</td>
                </tr>
                <tr>
                  <td></td>
                  <td>(832.765)</td>
                  <td>(4742.325)</td>
                  <td>(798.432)</td>
                  <td>(4329.104)</td>
                  <td>(850.457)</td>
                  <td>(7031.576)</td>
                  <td>(401.194)</td>
                  <td>(2708.329)</td>
                </tr>
                <tr>
                  <td>treat</td>
                  <td>395.247</td>
                  <td>319.158</td>
                  <td>1991.615</td>
                  <td>1926.426</td>
                  <td>1070.907</td>
                  <td>1207.183</td>
                  <td>1214.071</td>
                  <td>1237.405</td>
                </tr>
                <tr>
                  <td></td>
                  <td>(992.921)</td>
                  <td>(989.821)</td>
                  <td>(959.197)</td>
                  <td>(962.213)</td>
                  <td>(1248.129)</td>
                  <td>(1245.959)</td>
                  <td>(568.904)</td>
                  <td>(554.929)</td>
                </tr>
                <tr>
                  <td>age</td>
                  <td></td>
                  <td>0.738</td>
                  <td></td>
                  <td>43.983</td>
                  <td></td>
                  <td>147.970</td>
                  <td></td>
                  <td>-17.562</td>
                </tr>
                <tr>
                  <td></td>
                  <td></td>
                  <td>(63.289)</td>
                  <td></td>
                  <td>(59.595)</td>
                  <td></td>
                  <td>(107.716)</td>
                  <td></td>
                  <td>(33.570)</td>
                </tr>
                <tr>
                  <td>educ</td>
                  <td></td>
                  <td>513.097</td>
                  <td></td>
                  <td>462.507</td>
                  <td></td>
                  <td>879.978</td>
                  <td></td>
                  <td>489.248</td>
                </tr>
                <tr>
                  <td></td>
                  <td></td>
                  <td>(315.294)</td>
                  <td></td>
                  <td>(275.406)</td>
                  <td></td>
                  <td>(472.982)</td>
                  <td></td>
                  <td>(172.550)</td>
                </tr>
                <tr>
                  <td>black</td>
                  <td></td>
                  <td>-1441.462</td>
                  <td></td>
                  <td>-892.421</td>
                  <td></td>
                  <td>-1941.465</td>
                  <td></td>
                  <td>-1149.368</td>
                </tr>
                <tr>
                  <td></td>
                  <td></td>
                  <td>(1547.443)</td>
                  <td></td>
                  <td>(1526.070)</td>
                  <td></td>
                  <td>(2485.215)</td>
                  <td></td>
                  <td>(950.708)</td>
                </tr>
                <tr>
                  <td>hispanic</td>
                  <td></td>
                  <td>47.198</td>
                  <td></td>
                  <td>-171.481</td>
                  <td></td>
                  <td>437.208</td>
                  <td></td>
                  <td>202.126</td>
                </tr>
                <tr>
                  <td></td>
                  <td></td>
                  <td>(2391.301)</td>
                  <td></td>
                  <td>(2323.016)</td>
                  <td></td>
                  <td>(4223.958)</td>
                  <td></td>
                  <td>(1463.378)</td>
                </tr>
                <tr>
                  <td>married</td>
                  <td></td>
                  <td>294.628</td>
                  <td></td>
                  <td>282.877</td>
                  <td></td>
                  <td>-3213.470</td>
                  <td></td>
                  <td>424.461</td>
                </tr>
                <tr>
                  <td></td>
                  <td></td>
                  <td>(1268.718)</td>
                  <td></td>
                  <td>(1282.599)</td>
                  <td></td>
                  <td>(4445.151)</td>
                  <td></td>
                  <td>(807.171)</td>
                </tr>
                <tr>
                  <td>nodegree</td>
                  <td></td>
                  <td>17.309</td>
                  <td></td>
                  <td>159.611</td>
                  <td></td>
                  <td>1779.900</td>
                  <td></td>
                  <td>-92.470</td>
                </tr>
                <tr>
                  <td></td>
                  <td></td>
                  <td>(1401.818)</td>
                  <td></td>
                  <td>(1367.608)</td>
                  <td></td>
                  <td>(2019.035)</td>
                  <td></td>
                  <td>(844.246)</td>
                </tr>
                <tr>
                  <td>re74</td>
                  <td></td>
                  <td>0.082</td>
                  <td></td>
                  <td>0.056</td>
                  <td></td>
                  <td>-0.262</td>
                  <td></td>
                  <td>0.050</td>
                </tr>
                <tr>
                  <td></td>
                  <td></td>
                  <td>(0.132)</td>
                  <td></td>
                  <td>(0.121)</td>
                  <td></td>
                  <td>(0.601)</td>
                  <td></td>
                  <td>(0.078)</td>
                </tr>
                <tr>
                  <td>re75</td>
                  <td></td>
                  <td>0.200</td>
                  <td></td>
                  <td>0.163</td>
                  <td></td>
                  <td>2.034</td>
                  <td></td>
                  <td>0.318</td>
                </tr>
                <tr>
                  <td></td>
                  <td></td>
                  <td>(0.205)</td>
                  <td></td>
                  <td>(0.198)</td>
                  <td></td>
                  <td>(0.883)</td>
                  <td></td>
                  <td>(0.121)</td>
                </tr>
                <tr>
                  <td>Num.Obs.</td>
                  <td>263</td>
                  <td>263</td>
                  <td>267</td>
                  <td>267</td>
                  <td>140</td>
                  <td>140</td>
                  <td>614</td>
                  <td>614</td>
                </tr>
                <tr>
                  <td>R2</td>
                  <td>0.001</td>
                  <td>0.043</td>
                  <td>0.016</td>
                  <td>0.053</td>
                  <td>0.005</td>
                  <td>0.079</td>
                  <td>0.007</td>
                  <td>0.071</td>
                </tr>
                <tr>
                  <td>R2 Adj.</td>
                  <td>-0.003</td>
                  <td>0.009</td>
                  <td>0.012</td>
                  <td>0.020</td>
                  <td>-0.002</td>
                  <td>0.015</td>
                  <td>0.006</td>
                  <td>0.057</td>
                </tr>
        </tbody>
      </table>
    </div>
<!-- hack to avoid NA insertion in last line -->
</div>
</div>
<p>　IPWの場合、正の処置効果（ATT）が確認され、今回は統計的に有意な結果が得られた。</p>
</section>
<section id="バランスチェック" class="level2">
<h2 class="anchored" data-anchor-id="バランスチェック">バランスチェック</h2>
<p>　ここでは標準化差分以外のバランスチェック方法について紹介する。まず、特定の共変量の分布をヒストグラムを用い、マッチング前後で比較する方法だ。これもまた{coblat}パッケージを使用するが、今回は<code>love.plot()</code>でなく、<code>bal.plot()</code>を使う。</p>
<p>　第1引数は<code>matchit()</code>から得られたオブジェクト名、続いて<code>var.name</code>にはバランスをチェックする共変量名（傾向スコアの場合は<code>"distance"</code>）、他は以下のコードの通りに打てばよい。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb54-1"><a href="#cb54-1"></a><span class="fu">bal.plot</span>(ps_mat, <span class="at">var.name =</span> <span class="st">"distance"</span>, <span class="at">which =</span> <span class="st">"both"</span>,</span>
<span id="cb54-2"><a href="#cb54-2"></a>         <span class="at">type =</span> <span class="st">"histogram"</span>, <span class="at">mirror =</span> <span class="cn">TRUE</span>)</span></code><button title="コピー" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="matching_files/figure-html/unnamed-chunk-42-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="1050"></p>
</figure>
</div>
</div>
</div>
<p>　左がマッチング前、右が後である。また、上部の赤いヒストグラムは統制群、下部の青は処置群を意味する。もし、傾向スコアのバランスが取れているならヒストグラムは上下対称となる。マッチング前だと統制群は傾向スコアの値が小さく、処置群のそれは大きい傾向があったが、マッチング後はほぼ上下対称となっていることからバランスが改善されたことが分かる。</p>
<p>　ちなみに、ヒストグラムが作成できないダミー変数の場合、棒グラフが表示される。読み方は同じであるが、今回は上下対称ではなく、赤い棒と青い棒の高さが一致すればバランスが取れていると確認できる。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb55-1"><a href="#cb55-1"></a><span class="fu">bal.plot</span>(ps_mat, <span class="at">var.name =</span> <span class="st">"black"</span>, <span class="at">which =</span> <span class="st">"both"</span>,</span>
<span id="cb55-2"><a href="#cb55-2"></a>         <span class="at">type =</span> <span class="st">"histogram"</span>, <span class="at">mirror =</span> <span class="cn">TRUE</span>)</span></code><button title="コピー" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="matching_files/figure-html/unnamed-chunk-43-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="1050"></p>
</figure>
</div>
</div>
</div>
<p>　このようにヒストグラム（棒グラフ）を使うと、一つ一つの変数の図が必要となってくるので、実際の論文には掲載しにくい。それでも分析の段階では一つ一つのバランスを詳細に見ることは重要である。たとえば、傾向スコアマッチングの場合、回答者の年齢（<code>age</code>）のバランスは改善されている。本当にそうだろうか。<code>age</code>のバランスを確認してみよう。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb56-1"><a href="#cb56-1"></a><span class="fu">bal.plot</span>(ps_mat, <span class="at">var.name =</span> <span class="st">"age"</span>, <span class="at">which =</span> <span class="st">"both"</span>,</span>
<span id="cb56-2"><a href="#cb56-2"></a>         <span class="at">type =</span> <span class="st">"histogram"</span>, <span class="at">mirror =</span> <span class="cn">TRUE</span>)</span></code><button title="コピー" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="matching_files/figure-html/unnamed-chunk-44-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="1050"></p>
</figure>
</div>
</div>
</div>
<p>　改善ところか、改悪されているとも読み取れる。標準化差分は平均値と標準誤差のみに依存するため、分布の情報までは分からない。このような場合は、処置効果の推定の際、共変量を投入して更に調整が必要であることを示唆する。</p>
</section>
<section id="推定値の比較" class="level2">
<h2 class="anchored" data-anchor-id="推定値の比較">推定値の比較</h2>
<p>　これまで見てきたように、同じく「マッチング」とは言っても手法によって結果のばらつきが大きいことが分かる。また、同じ手法であっても復元か、非復元か、1:1マッチングか、1:nマッチングか、CEMならレイヤーをどれほど細かくするかなどによっても結果は大きく変わる。</p>
<p>　ここまで得られた多くの結果から自分にとって都合の良い結果のみを報告するのは、あるいみ研究<strong>不正</strong>に近い。なぜなら、これを逆にいうと自分にとって都合の悪い結果を隠蔽しているものだからだ。したがって、実際の論文にはそれぞれの結果を報告・比較し、その結果を慎重に解釈する必要がある。ここではこれまで推定してきたマッチングの結果を一つの図としてまとめてみよう。</p>
<p>　まずは、{broom}パッケージの<code>tidy()</code>関数で回帰分析の結果を表でまとめ、<code>bind_rows()</code>を使って一つに統合する。<code>tidy()</code>内に<code>conf.int = TRUE</code>を入れておくと、95%信頼区間も出してくれるので、今の段階で入れておこう。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb57-1"><a href="#cb57-1"></a>att_df <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(<span class="fu">list</span>(<span class="st">"単回帰_最近傍（マハラノビス）"</span> <span class="ot">=</span> <span class="fu">tidy</span>(mh_fit3, <span class="at">conf.int =</span> <span class="cn">TRUE</span>),</span>
<span id="cb57-2"><a href="#cb57-2"></a>                         <span class="st">"重回帰_最近傍（マハラノビス）"</span> <span class="ot">=</span> <span class="fu">tidy</span>(mh_fit4, <span class="at">conf.int =</span> <span class="cn">TRUE</span>),</span>
<span id="cb57-3"><a href="#cb57-3"></a>                         <span class="st">"単回帰_最近傍（傾向スコア）"</span>   <span class="ot">=</span> <span class="fu">tidy</span>(ps_fit1, <span class="at">conf.int =</span> <span class="cn">TRUE</span>),</span>
<span id="cb57-4"><a href="#cb57-4"></a>                         <span class="st">"重回帰_最近傍（傾向スコア）"</span>   <span class="ot">=</span> <span class="fu">tidy</span>(ps_fit2, <span class="at">conf.int =</span> <span class="cn">TRUE</span>),</span>
<span id="cb57-5"><a href="#cb57-5"></a>                         <span class="st">"単回帰_CEM"</span> <span class="ot">=</span> <span class="fu">tidy</span>(cem_fit1, <span class="at">conf.int =</span> <span class="cn">TRUE</span>),</span>
<span id="cb57-6"><a href="#cb57-6"></a>                         <span class="st">"重回帰_CEM"</span> <span class="ot">=</span> <span class="fu">tidy</span>(cem_fit2, <span class="at">conf.int =</span> <span class="cn">TRUE</span>),</span>
<span id="cb57-7"><a href="#cb57-7"></a>                         <span class="st">"単回帰_IPW"</span> <span class="ot">=</span> <span class="fu">tidy</span>(ipw_fit1, <span class="at">conf.int =</span> <span class="cn">TRUE</span>),</span>
<span id="cb57-8"><a href="#cb57-8"></a>                         <span class="st">"重回帰_IPW"</span> <span class="ot">=</span> <span class="fu">tidy</span>(ipw_fit2, <span class="at">conf.int =</span> <span class="cn">TRUE</span>)),</span>
<span id="cb57-9"><a href="#cb57-9"></a>                    <span class="at">.id =</span> <span class="st">"Model"</span>)</span>
<span id="cb57-10"><a href="#cb57-10"></a></span>
<span id="cb57-11"><a href="#cb57-11"></a>att_df</span></code><button title="コピー" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 48 × 8
   Model          term  estimate std.error statistic  p.value conf.low conf.high
   &lt;chr&gt;          &lt;chr&gt;    &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt;     &lt;dbl&gt;
 1 単回帰_最近傍（マハラノビ… (Int…  5.95e+3     833.     7.15   8.74e-12    4314.     7594.
 2 単回帰_最近傍（マハラノビ… treat  3.95e+2     993.     0.398  6.91e- 1   -1560.     2350.
 3 重回帰_最近傍（マハラノビ… (Int…  1.37e+3    4742.     0.288  7.73e- 1   -7972.    10707.
 4 重回帰_最近傍（マハラノビ… treat  3.19e+2     990.     0.322  7.47e- 1   -1630.     2268.
 5 重回帰_最近傍（マハラノビ… age    7.38e-1      63.3    0.0117 9.91e- 1    -124.      125.
 6 重回帰_最近傍（マハラノビ… educ   5.13e+2     315.     1.63   1.05e- 1    -108.     1134.
 7 重回帰_最近傍（マハラノビ… black -1.44e+3    1547.    -0.932  3.52e- 1   -4489.     1606.
 8 重回帰_最近傍（マハラノビ… hisp…  4.72e+1    2391.     0.0197 9.84e- 1   -4662.     4757.
 9 重回帰_最近傍（マハラノビ… marr…  2.95e+2    1269.     0.232  8.17e- 1   -2204.     2793.
10 重回帰_最近傍（マハラノビ… node…  1.73e+1    1402.     0.0123 9.90e- 1   -2743.     2778.
# ℹ 38 more rows</code></pre>
</div>
</div>
<p>　続いて、処置効果（ATT）を意味する行のみを残す。<code>term</code>の値が<code>"treat"</code>と一致する行が処置効果である。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb59"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb59-1"><a href="#cb59-1"></a>att_df <span class="ot">&lt;-</span> att_df <span class="sc">|&gt;</span></span>
<span id="cb59-2"><a href="#cb59-2"></a>  <span class="fu">filter</span>(term <span class="sc">==</span> <span class="st">"treat"</span>)</span>
<span id="cb59-3"><a href="#cb59-3"></a></span>
<span id="cb59-4"><a href="#cb59-4"></a>att_df</span></code><button title="コピー" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 8 × 8
  Model            term  estimate std.error statistic p.value conf.low conf.high
  &lt;chr&gt;            &lt;chr&gt;    &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;   &lt;dbl&gt;    &lt;dbl&gt;     &lt;dbl&gt;
1 単回帰_最近傍（マハラノビス）… treat     395.      993.     0.398  0.691   -1560.      2350.
2 重回帰_最近傍（マハラノビス）… treat     319.      990.     0.322  0.747   -1630.      2268.
3 単回帰_最近傍（傾向スコア）…… treat    1992.      959.     2.08   0.0388    103.      3880.
4 重回帰_最近傍（傾向スコア）…… treat    1926.      962.     2.00   0.0463     31.6     3821.
5 単回帰_CEM       treat    1071.     1248.     0.858  0.392   -1397.      3539.
6 重回帰_CEM       treat    1207.     1246.     0.969  0.334   -1258.      3672.
7 単回帰_IPW       treat    1214.      569.     2.13   0.0332     96.8     2331.
8 重回帰_IPW       treat    1237.      555.     2.23   0.0261    148.      2327.</code></pre>
</div>
</div>
<p>　ここでは新しく登場した関数を使用する。<code>separate()</code>関数は文字列で構成されている列を、特定の文字を基準に列分割する関数である。<code>Model</code>行のそれぞれの値は<code>回帰モデル_マッチングモデル</code>で構成され、これを<code>_</code>文字を基準に<code>Regression</code>と<code>Method</code>列に分割する。分割する列名は<code>col</code>、分割後の列名は<code>into</code>、分割の基準となる文字は<code>sep</code>に指定する。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb61"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb61-1"><a href="#cb61-1"></a>att_df <span class="ot">&lt;-</span> att_df <span class="sc">|&gt;</span></span>
<span id="cb61-2"><a href="#cb61-2"></a>  <span class="fu">separate</span>(<span class="at">col  =</span> Model,</span>
<span id="cb61-3"><a href="#cb61-3"></a>           <span class="at">into =</span> <span class="fu">c</span>(<span class="st">"Regression"</span>, <span class="st">"Method"</span>),</span>
<span id="cb61-4"><a href="#cb61-4"></a>           <span class="at">sep  =</span> <span class="st">"_"</span>)</span>
<span id="cb61-5"><a href="#cb61-5"></a></span>
<span id="cb61-6"><a href="#cb61-6"></a>att_df</span></code><button title="コピー" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 8 × 9
  Regression Method          term  estimate std.error statistic p.value conf.low
  &lt;chr&gt;      &lt;chr&gt;           &lt;chr&gt;    &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;   &lt;dbl&gt;    &lt;dbl&gt;
1 単回帰     最近傍（マハラノビス）…… treat     395.      993.     0.398  0.691   -1560. 
2 重回帰     最近傍（マハラノビス）…… treat     319.      990.     0.322  0.747   -1630. 
3 単回帰     最近傍（傾向スコア）…… treat    1992.      959.     2.08   0.0388    103. 
4 重回帰     最近傍（傾向スコア）…… treat    1926.      962.     2.00   0.0463     31.6
5 単回帰     CEM             treat    1071.     1248.     0.858  0.392   -1397. 
6 重回帰     CEM             treat    1207.     1246.     0.969  0.334   -1258. 
7 単回帰     IPW             treat    1214.      569.     2.13   0.0332     96.8
8 重回帰     IPW             treat    1237.      555.     2.23   0.0261    148. 
# ℹ 1 more variable: conf.high &lt;dbl&gt;</code></pre>
</div>
</div>
<p>　後はこのデータを使って作図するだけである。データを<code>ggplot()</code>に渡す前に<code>Regression</code>と<code>Method</code>列をfactor化しておこう。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb63"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb63-1"><a href="#cb63-1"></a>att_df <span class="sc">|&gt;</span></span>
<span id="cb63-2"><a href="#cb63-2"></a>  <span class="fu">mutate</span>(<span class="at">Regression =</span> <span class="fu">fct_inorder</span>(Regression),</span>
<span id="cb63-3"><a href="#cb63-3"></a>         <span class="at">Method     =</span> <span class="fu">fct_inorder</span>(Method)) <span class="sc">|&gt;</span></span>
<span id="cb63-4"><a href="#cb63-4"></a>  <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb63-5"><a href="#cb63-5"></a>  <span class="fu">geom_pointrange</span>(<span class="fu">aes</span>(<span class="at">x =</span> estimate, <span class="at">y =</span> Method,</span>
<span id="cb63-6"><a href="#cb63-6"></a>                      <span class="at">xmin =</span> conf.low, <span class="at">xmax =</span> conf.high,</span>
<span id="cb63-7"><a href="#cb63-7"></a>                      <span class="at">color =</span> Regression),</span>
<span id="cb63-8"><a href="#cb63-8"></a>                  <span class="at">position =</span> <span class="fu">position_dodge2</span>(<span class="dv">1</span><span class="sc">/</span><span class="dv">2</span>)) <span class="sc">+</span></span>
<span id="cb63-9"><a href="#cb63-9"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"処置群における処置効果（ATT）"</span>, <span class="at">y =</span> <span class="st">""</span>, <span class="at">color =</span> <span class="st">"モデル"</span>,</span>
<span id="cb63-10"><a href="#cb63-10"></a>       <span class="at">caption =</span> <span class="st">"注: マッチングの場合、復元マッチングを行った。"</span>) <span class="sc">+</span></span>
<span id="cb63-11"><a href="#cb63-11"></a>  <span class="fu">theme_bw</span>(<span class="at">base_size =</span> <span class="dv">12</span>)</span></code><button title="コピー" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="matching_files/figure-html/unnamed-chunk-48-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="1050"></p>
</figure>
</div>
</div>
</div>
<p>　もし、縦軸の順番を逆にしたい場合は、<code>fct_rev()</code>関数で要素の順番を逆にする。</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb64"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb64-1"><a href="#cb64-1"></a>att_df <span class="sc">|&gt;</span></span>
<span id="cb64-2"><a href="#cb64-2"></a>  <span class="fu">mutate</span>(<span class="at">Regression =</span> <span class="fu">fct_inorder</span>(Regression),</span>
<span id="cb64-3"><a href="#cb64-3"></a>         <span class="at">Method     =</span> <span class="fu">fct_inorder</span>(Method),</span>
<span id="cb64-4"><a href="#cb64-4"></a>         <span class="at">Method     =</span> <span class="fu">fct_rev</span>(Method)) <span class="sc">|&gt;</span></span>
<span id="cb64-5"><a href="#cb64-5"></a>  <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb64-6"><a href="#cb64-6"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="dv">0</span>) <span class="sc">+</span></span>
<span id="cb64-7"><a href="#cb64-7"></a>  <span class="fu">geom_pointrange</span>(<span class="fu">aes</span>(<span class="at">x =</span> estimate, <span class="at">y =</span> Method,</span>
<span id="cb64-8"><a href="#cb64-8"></a>                      <span class="at">xmin =</span> conf.low, <span class="at">xmax =</span> conf.high,</span>
<span id="cb64-9"><a href="#cb64-9"></a>                      <span class="at">color =</span> Regression),</span>
<span id="cb64-10"><a href="#cb64-10"></a>                  <span class="at">position =</span> <span class="fu">position_dodge2</span>(<span class="dv">1</span><span class="sc">/</span><span class="dv">2</span>)) <span class="sc">+</span></span>
<span id="cb64-11"><a href="#cb64-11"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"処置群における処置効果（ATT）"</span>, <span class="at">y =</span> <span class="st">""</span>, <span class="at">color =</span> <span class="st">"モデル"</span>,</span>
<span id="cb64-12"><a href="#cb64-12"></a>       <span class="at">caption =</span> <span class="st">"注: マッチングの場合、復元マッチングを行った。"</span>) <span class="sc">+</span></span>
<span id="cb64-13"><a href="#cb64-13"></a>  <span class="fu">theme_bw</span>(<span class="at">base_size =</span> <span class="dv">12</span>)</span></code><button title="コピー" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="matching_files/figure-html/unnamed-chunk-49-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="1050"></p>
</figure>
</div>
</div>
</div>


</section>


<div id="quarto-appendix" class="default"><section id="footnotes" class="footnotes footnotes-end-of-document" role="doc-endnotes"><h2 class="anchored quarto-appendix-heading">脚注</h2>

<ol>
<li id="fn1"><p>lalondeデータセットを提供するパッケージは複数あり、それぞれデータセットの構成に違いがある。どれを使っても実習には問題ないが、本資料の内容を再現される場合は<code>data()</code>内に<code>package = "cobalt"</code>を指定しよう。<a href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn2"><p>人種のダミーは3つであるが、全てを投入する場合、多重共線性により、推定ができない（Rだと勝手に一つ落としてくれる）。必ず、一つは抜く必要があり、ここでは白人ダミー（<code>white</code>）を除外して。除外された変数をベースカテゴリ、参照カテゴリと呼ぶ。<a href="#fnref2" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn3"><p>ここでは基準としている標準化差分0.25は{BalanceR}の25と同じである。<a href="#fnref3" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn4"><p>これは<code>matchit()</code>内に<code>replacement = TRUE</code>を指定することで防ぐことができる。既定値は<code>FALSE</code>だが、<code>TRUE</code>を指定すれば、マッチングされた統制群ケースを2回以上マッチングすることができる。どちらが正しいということはないが、非復元（<code>FALSE</code>）が一般的だという意見もある（Lanza et al.&nbsp;2013）。<a href="#fnref4" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn5"><p>これは<code>matchit()</code>内に<code>ratio</code>引数を指定することで防ぐことができる。既定値は1であり、この場合は1:1マッチングを意味する。<a href="#fnref5" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn6"><p><a href="https://doi.org/10.1002/sim.8502">Austin, Peter C., and Guy Cafri. 2020. “Variance Estimation When Using Propensity-Score Matching with Replacement with Survival or Time-to-Event Outcomes.” <em>Statistics in Medicine,</em> 39 (11): 1623–40.</a><a href="#fnref6" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn7"><p>実は<code>nearest = "logit"</code>が省略されている。つまり、ロジスティック回帰分析から得られた傾向スコアの距離に基づくマッチングを意味する。<a href="#fnref7" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn8"><p><a href="https://imai.fas.harvard.edu/research/CBPS.html">Imai, Kosuke and Marc Ratkovic. 2014. “Covariate Balancing Propensity Score.” <em>Journal of the Royal Statistical Society, Series B,</em> Vol. 76, No.&nbsp;1, pp.&nbsp;243-246.</a><a href="#fnref8" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn9"><p>Super Learnerを使った例は「<a href="">Cyrus, Samii, Laura Paler, and Sarah Zukerman Daly. 2016. “Retrospective Causal Inference with Machine Learning Ensembles: An Application to Anti-recidivism Policies in Colombia.” <em>Political Analysis,</em> 22 (4) pp.&nbsp;434-456</a>」を、日本語による解説は<a href="https://www.jaysong.net">誰か</a>の<a href="https://www.slideshare.net/tintstyle/review-cyrus-samii-laura-paler-and-sarah-zukerman-daly-2016-retrospective-causal-inference-with-machine-learning-ensembles-an-application-to-antirecidivism-policies-in-colombia-political-analysis-22-4-pp-434456">報告スライド</a>を参照して下さい。<a href="#fnref9" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
</ol>
</section></div></main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "コピーしました");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "コピーしました");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("https:\/\/www\.jaysong\.net\/kandai-ci\/");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
          // target, if specified
          link.setAttribute("target", "_blank");
          if (link.getAttribute("rel") === null) {
            link.setAttribute("rel", "noopener");
          }
          // default icon
          link.classList.add("external");
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="../material/r.html" class="pagination-link" aria-label="Rの復習">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text">Rの復習</span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="../material/did.html" class="pagination-link" aria-label="差分の差分法">
        <span class="nav-page-text">差分の差分法</span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
      &nbsp;
    </div>   
    <div class="nav-footer-center">
      &nbsp;
    </div>
    <div class="nav-footer-right">
      <ul class="footer-items list-unstyled">
    <li class="nav-item">
 © 2025 Jaehyun Song
  </li>  
    <li class="nav-item compact">
    <a class="nav-link" href="https://www.jaysong.net">
      <i class="bi bi-house-fill" role="img">
</i> 
    </a>
  </li>  
    <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/JaehyunSong">
      <i class="bi bi-github" role="img">
</i> 
    </a>
  </li>  
</ul>
    </div>
  </div>
</footer>




</body></html>